<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador TPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tpsDarkBlue: '#023047',
            tpsOrange:   '#fb8500',
            tpsWhite:    '#ffffff',
          }
        }
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Estilos esenciales (sin cambios) */
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
    .custom-scrollbar::-webkit-scrollbar { width:6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background:#888; border-radius:3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background:#555; }
    .floating-cart-bubble {
      position:fixed; bottom:20px; left:20px;
      background:#023047; color:#fff; border-radius:50%;
      width:60px; height:60px; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:transform .3s; z-index:1000;
    }
    .floating-cart-bubble:hover { transform:scale(1.1); }
    .floating-cart-bubble .cart-count {
      position:absolute; top:-5px; right:-5px;
      background:#fb8500; color:#fff; font-size:.75rem;
      font-weight:bold; padding:2px 6px; border-radius:9999px;
    }
    .cart-panel-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; justify-content:end;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s;
    }
    .cart-panel-overlay.visible { visibility:visible; opacity:1; }
    .cart-panel {
      background:#fff; width:90%; max-width:400px; height:100%;
      box-shadow:-4px 0 12px rgba(0,0,0,0.2);
      display:flex; flex-direction:column; transform:translateX(100%);
      transition:transform .3s;
    }
    .cart-panel.open { transform:translateX(0); }
    .cart-panel-header, .cart-panel-footer { padding:1rem; border-color:#e5e7eb; }
    .cart-panel-header { border-bottom:1px solid; display:flex; justify-content:space-between; align-items:center; }
    .cart-panel-body { flex-grow:1; overflow-y:auto; padding:1rem; }
    .step { display:none; }
    .step.active { display:block; }
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s; z-index:1100;
    }
    .modal-overlay.visible { visibility:visible; opacity:1; }
    .modal {
      background:#fff; padding:1.5rem; border-radius:.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      width:90%; max-width:400px; transform:translateY(-20px);
      transition:transform .3s;
    }
    .modal-overlay.visible .modal { transform:translateY(0); }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <div class="container mx-auto px-4 py-8">
    <!-- Header (sin cambios) -->
    <header class="mb-10 flex flex-col sm:flex-row items-center justify-center">
      <img src="logotps.png" alt="Logo TPS" class="h-16 mb-4 sm:mb-0 sm:mr-4"/>
      <div>
        <h1 class="text-4xl font-bold text-center text-tpsDarkBlue mb-2">Cotizador TPS</h1>
        <p class="text-center text-gray-600">Genera cotizaciones rápidas</p>
      </div>
      <button id="openCalculatorModalBtn" class="ml-0 sm:ml-6 mt-4 sm:mt-0 bg-tpsOrange text-tpsWhite py-2 px-4 rounded-md hover:bg-orange-600 flex items-center text-sm">
        <i class="fas fa-calculator mr-2"></i> Calculadora
      </button>
    </header>

    <div id="appContainer" class="relative">
      <!-- Paso 1 (sin cambios) -->
      <div id="step1" class="step active">
        <!-- Filtros -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
          <h2 class="text-xl font-semibold mb-4">Filtros</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <input id="filterKeyword1" placeholder="Clave 1" class="border p-2 rounded"/>
            <input id="filterKeyword2" placeholder="Clave 2" class="border p-2 rounded"/>
            <input id="filterKeyword3" placeholder="Clave 3" class="border p-2 rounded"/>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="flex space-x-2"><input id="minPrice" type="number" placeholder="Mín" class="border p-2 rounded"/><input id="maxPrice" type="number" placeholder="Máx" class="border p-2 rounded"/></div>
            <select id="sortBy" class="border p-2 rounded">
              <option value="name-asc">Nombre A-Z</option>
              <option value="name-desc">Nombre Z-A</option>
              <option value="price-asc">Precio ↑</option>
              <option value="price-desc">Precio ↓</option>
            </select>
            <button id="applyFilters" class="bg-tpsDarkBlue text-white py-2 rounded flex items-center justify-center">
              <i class="fas fa-filter mr-2"></i> Aplicar
            </button>
          </div>
        </div>
        <!-- Productos -->
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Productos</h2>
            <button id="openCustomProductModalBtn" class="bg-tpsOrange text-white py-2 px-4 rounded flex items-center text-sm">
              <i class="fas fa-plus mr-2"></i> Personalizado
            </button>
          </div>
          <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p class="text-gray-500 text-center">Cargando...</p>
          </div>
          <div id="noProductsMessage" class="hidden text-center py-10 text-gray-500"><i class="fas fa-box-open text-4xl mb-3"></i>No hay productos</div>
          <div id="pagination" class="flex justify-center items-center mt-6 space-x-4">
            <button id="prevPageBtn" class="bg-gray-300 py-2 px-4 rounded disabled:opacity-50"><i class="fas fa-arrow-left mr-2"></i>Anterior</button>
            <span id="pageInfo">Página 1 de 1</span>
            <button id="nextPageBtn" class="bg-gray-300 py-2 px-4 rounded disabled:opacity-50">Siguiente<i class="fas fa-arrow-right ml-2"></i></button>
          </div>
        </div>
      </div>

      <!-- Paso 2 (sin cambios) -->
      <div id="step2" class="step">
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-xl font-semibold mb-6">Datos</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="prospectName" placeholder="Nombre prospecto" class="border p-2 rounded"/>
            <input id="prospectCompany" placeholder="Empresa prospecto" class="border p-2 rounded"/>
            <input id="projectName" placeholder="Proyecto" class="border p-2 rounded"/>
            <input id="prospectPhone" placeholder="Teléfono (WhatsApp)" class="border p-2 rounded"/>
            <input id="salespersonName" placeholder="Nombre vendedor" class="border p-2 rounded"/>
            <input id="salespersonPhone" placeholder="Teléfono vendedor" class="border p-2 rounded"/>
            <input id="salespersonEmail" placeholder="Correo vendedor" class="border p-2 rounded"/>
          </div>
          <div class="mt-6 flex flex-col sm:flex-row justify-between items-center">
            <button id="backToCart" class="bg-gray-300 text-gray-800 py-2 px-4 rounded flex items-center mb-4 sm:mb-0">
              <i class="fas fa-arrow-left mr-2"></i> Volver
            </button>
            <div class="flex space-x-3 w-full sm:w-auto">
              <button id="generatePdfBtn" disabled class="bg-green-600 text-white py-2 px-4 rounded disabled:opacity-50 flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> PDF
              </button>
              <button id="sendWhatsappBtn" disabled class="bg-green-500 text-white py-2 px-4 rounded disabled:opacity-50 flex items-center">
                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Carrito flotante (sin cambios) -->
  <div id="floatingCartBubble" class="floating-cart-bubble hidden">
    <i class="fas fa-shopping-cart text-2xl"></i>
    <span id="cartCountBubble" class="cart-count">0</span>
  </div>

  <!-- Panel de carrito (sin cambios) -->
  <div id="cartPanelOverlay" class="cart-panel-overlay hidden">
    <div id="cartPanel" class="cart-panel">
      <div class="cart-panel-header">
        <h2 class="font-semibold">Tu Cotización</h2>
        <button id="closeCartPanel"><i class="fas fa-times"></i></button>
      </div>
      <div id="cartItemsPanel" class="cart-panel-body custom-scrollbar">
        <p class="text-gray-500 text-center py-10">Agrega productos</p>
      </div>
      <div class="cart-panel-footer">
        <input id="globalDiscountPanel" type="number" min="0" max="100" value="0" class="w-full p-2 border rounded mb-4" placeholder="Descuento %"/>
        <div class="space-y-2 mb-4">
          <div class="flex justify-between"><span>Subtotal:</span><span id="subtotalPanel">$0.00</span></div>
          <div class="flex justify-between"><span>Descuento:</span><span id="discountAmountPanel">-$0.00</span></div>
          <div class="flex justify-between"><span>Sub c/Desc:</span><span id="subtotalAfterDiscountPanel">$0.00</span></div>
          <div class="flex justify-between"><span>IVA 16%:</span><span id="taxPanel">$0.00</span></div>
          <div class="flex justify-between font-semibold"><span>Total:</span><span id="totalPanel">$0.00</span></div>
        </div>
        <button id="nextToFormBtn" class="w-full bg-tpsDarkBlue text-white py-2 rounded mb-3 disabled:opacity-50 flex items-center justify-center">
          Siguiente <i class="fas fa-arrow-right ml-2"></i>
        </button>
        <button id="clearCartPanelBtn" class="w-full bg-gray-200 text-gray-800 py-2 rounded flex items-center justify-center">
          <i class="fas fa-trash-alt mr-2"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal producto personalizado (sin cambios) -->
  <div id="customProductModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">Producto Personalizado</h3>
        <button id="closeCustomProductModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <input id="customProductDescription" placeholder="Descripción" class="w-full p-2 border rounded mb-4"/>
      <input id="customProductPrice" type="number" step="0.01" placeholder="Precio sin IVA" class="w-full p-2 border rounded mb-6"/>
      <button id="addCustomProductToCartBtn" class="w-full bg-tpsOrange text-white py-2 rounded flex items-center justify-center">
        <i class="fas fa-plus-circle mr-2"></i> Agregar
      </button>
    </div>
  </div>

  <!-- Modal calculadora (sin cambios) -->
  <div id="calculatorModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-6">
        <h3 class="font-semibold">Calculadora Mezclas</h3>
        <button id="closeCalculatorModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <input id="mezclaArea" type="number" step="0.01" placeholder="Área m²" class="border p-2 rounded"/>
        <input id="mezclaRendimiento" type="number" step="0.01" placeholder="Rend m²/L" class="border p-2 rounded"/>
      </div>
      <div class="mb-6">
        <label class="block mb-1">Relación A:B:C</label>
        <div class="flex items-center space-x-2">
          <input id="mezclaParteA" type="number" value="4" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteB" type="number" value="1" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteC" type="number" value="0" min="0" class="w-1/3 p-2 border rounded text-center"/>
        </div>
      </div>
      <button id="calcularMezclaBtn" class="w-full bg-tpsDarkBlue text-white py-2 rounded flex items-center justify-center mb-6">
        <i class="fas fa-calculator mr-2"></i> Calcular
      </button>
      <div id="mezclaResultado" class="hidden p-4 bg-gray-100 rounded mb-4">
        <p id="mezclaTotalNecesaria" class="mb-2"></p>
        <p id="mezclaResultadoParteA" class="mb-2"></p>
        <p id="mezclaResultadoParteB" class="mb-2"></p>
        <p id="mezclaResultadoParteC"></p>
      </div>
      <div id="mezclaError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <p id="mezclaErrorMessage"></p>
      </div>
    </div>
  </div>

  <script>
    const companyInfo = {
      name:    "TPS Recubrimientos",
      address: "Calle Ficticia #123",
      phone:   "55 1234 5678",
      email:   "contacto@tpsrecubrimientos.com",
      logoUrl: "logotps.png"
    };

    let products = [], cart = [], filteredProducts = [], customProductCounter = 0;
    const itemsPerPage = 9; let currentPage = 1;

    // Elementos (sin cambios)
    const step1  = document.getElementById('step1'),
          step2  = document.getElementById('step2'),
          bubble = document.getElementById('floatingCartBubble'),
          panelO = document.getElementById('cartPanelOverlay'),
          panel  = document.getElementById('cartPanel'),
          nextBtn= document.getElementById('nextToFormBtn'),
          customOverlay  = document.getElementById('customProductModalOverlay'),
          calcOverlay    = document.getElementById('calculatorModalOverlay');

    // --- Funciones Auxiliares ---

    // CORREGIDO: Función segura para obtener el precio como número
    function getSafePrice(priceValue) {
      // 1. Asegura que sea string (incluso si es null, undefined o number)
      // 2. Reemplaza la coma decimal si existe
      // 3. Convierte a float, o devuelve 0 si falla
      return parseFloat(String(priceValue || '0').replace(',', '.')) || 0;
    }

    // --- Event Listener Principal ---
    document.addEventListener('DOMContentLoaded',()=>{
      loadProducts();
      setupEventListeners();
      loadCart();
      updateCart(); // Llama a updateCart después de cargar el carrito
      updateCartBubbleCount(); // Asegura que el contador de la burbuja se actualice al inicio
    });

    // --- Carga y Manejo de Productos ---
    function loadProducts(){
      fetch('productos.json')
        .then(r => r.ok ? r.json() : Promise.reject(`HTTP error! status: ${r.status}`))
        .then(data => {
          if (!Array.isArray(data)) {
            throw new Error("El formato de productos.json no es un array válido.");
          }
          // Aseguramos que cada producto tenga las propiedades esperadas, aunque estén vacías
          products = data.map(p => ({
             Clave: p.Clave || `generated-${Math.random()}`, // Añadir clave si falta
             Descripcion: p.Descripcion || 'Producto sin descripción',
             PrecioPublico: p.PrecioPublico // Mantenemos el tipo original (string o number)
             // Añade otras propiedades que esperes aquí con valores por defecto si es necesario
          }));
          filteredProducts = [...products];
          applyFilters(); // Llama a applyFilters aquí, después de cargar y procesar
        })
        .catch(e => {
          console.error("Error cargando o procesando productos.json:", e);
          document.getElementById('productsContainer').innerHTML = `<p class="text-red-600 text-center col-span-full">Error cargando productos: ${e.message}. Revisa la consola.</p>`;
          document.getElementById('pagination').classList.add('hidden');
        });
    }

    // --- Carrito (LocalStorage y Contador Burbuja) ---
    function saveCart(){
      try {
        localStorage.setItem('tpsCart', JSON.stringify(cart));
      } catch (e) {
        console.error("Error guardando el carrito en localStorage:", e);
        showNotification("Error al guardar el carrito", "bg-red-600");
      }
      updateCartBubbleCount();
    }

    function loadCart(){
      const savedCart = localStorage.getItem('tpsCart');
      if (savedCart) {
        try {
          cart = JSON.parse(savedCart) || [];
          // Validar que los items cargados tengan la estructura esperada
          cart = cart.filter(item => item && item.Clave && typeof item.quantity === 'number');
        } catch (e) {
          console.error("Error cargando el carrito desde localStorage:", e);
          cart = [];
          localStorage.removeItem('tpsCart'); // Limpiar storage si está corrupto
        }
      } else {
        cart = [];
      }
    }

    function updateCartBubbleCount(){
      const totalQuantity = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
      const bubbleCountElement = document.getElementById('cartCountBubble');
      if (bubbleCountElement) {
        bubbleCountElement.textContent = totalQuantity;
      }
      if (totalQuantity > 0) {
        bubble.classList.remove('hidden');
      } else {
        bubble.classList.add('hidden');
      }
    }

    // --- Event Listeners Generales ---
    function setupEventListeners(){
      // Filtros y Paginación
      ['filterKeyword1','filterKeyword2','filterKeyword3'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.addEventListener('input', () => { currentPage = 1; applyFilters(); });
      });
       ['minPrice', 'maxPrice'].forEach(id => {
         const input = document.getElementById(id);
         if(input) input.addEventListener('input', () => { currentPage = 1; applyFilters(); });
       });

      const applyFiltersBtn = document.getElementById('applyFilters');
      if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', () => { currentPage = 1; applyFilters(); });

      const sortBySelect = document.getElementById('sortBy');
      if (sortBySelect) sortBySelect.addEventListener('change', () => { currentPage = 1; applyFilters(); });

      const prevPageBtn = document.getElementById('prevPageBtn');
      if (prevPageBtn) prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) { currentPage--; renderProducts(filteredProducts); }
      });

      const nextPageBtn = document.getElementById('nextPageBtn');
      if (nextPageBtn) nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
        if (currentPage < totalPages) { currentPage++; renderProducts(filteredProducts); }
      });

      // Descuento Global
      const globalDiscountInput = document.getElementById('globalDiscountPanel');
      if (globalDiscountInput) globalDiscountInput.addEventListener('input', updateCart);

      // Modales (Producto Personalizado y Calculadora)
      const openCustomModalBtn = document.getElementById('openCustomProductModalBtn');
      if (openCustomModalBtn) openCustomModalBtn.addEventListener('click', () => customOverlay.classList.add('visible'));

      const closeCustomModalBtn = document.getElementById('closeCustomProductModalBtn');
      if (closeCustomModalBtn) closeCustomModalBtn.addEventListener('click', () => customOverlay.classList.remove('visible'));

      const addCustomProductBtn = document.getElementById('addCustomProductToCartBtn');
      if (addCustomProductBtn) addCustomProductBtn.addEventListener('click', addCustomProductToCart);

      const openCalcModalBtn = document.getElementById('openCalculatorModalBtn');
      if (openCalcModalBtn) openCalcModalBtn.addEventListener('click', () => {
        if(calcOverlay) {
          calcOverlay.classList.add('visible');
          const resultado = document.getElementById('mezclaResultado');
          const errorDiv = document.getElementById('mezclaError');
          if(resultado) resultado.classList.add('hidden');
          if(errorDiv) errorDiv.classList.add('hidden');
        }
      });

      const closeCalcModalBtn = document.getElementById('closeCalculatorModalBtn');
      if (closeCalcModalBtn) closeCalcModalBtn.addEventListener('click', () => calcOverlay.classList.remove('visible'));

      const calcularMezclaBtn = document.getElementById('calcularMezclaBtn');
      if (calcularMezclaBtn) calcularMezclaBtn.addEventListener('click', calcularMezcla);

      // Panel del Carrito
      if (bubble) bubble.addEventListener('click', openCartPanel);

      const closeCartPanelBtn = document.getElementById('closeCartPanel');
      if (closeCartPanelBtn) closeCartPanelBtn.addEventListener('click', closeCartPanel);

      // Navegación y Acciones Finales
      if (nextBtn) nextBtn.addEventListener('click', goToFormStep);

      const backToCartBtn = document.getElementById('backToCart');
      if (backToCartBtn) backToCartBtn.addEventListener('click', backToCotizadorStep);

      const generatePdfBtn = document.getElementById('generatePdfBtn');
      if (generatePdfBtn) generatePdfBtn.addEventListener('click', generatePdf);

      const sendWhatsappBtn = document.getElementById('sendWhatsappBtn');
      if (sendWhatsappBtn) sendWhatsappBtn.addEventListener('click', sendWhatsappQuote);

      const clearCartBtn = document.getElementById('clearCartPanelBtn');
      if (clearCartBtn) clearCartBtn.addEventListener('click', clearCart);
    }

    // --- Lógica de UI (Paneles, Modales, Pasos) ---
    function openCartPanel(){
      updateCart(); // Actualiza el contenido antes de mostrar
      if (panelO) {
        panelO.classList.remove('hidden');
        panelO.classList.add('visible');
        setTimeout(() => { if(panel) panel.classList.add('open'); }, 10); // Da tiempo a la visibilidad
      }
    }

    function closeCartPanel(){
      if (panel) {
        panel.classList.remove('open');
        // Espera a que termine la transición de transform antes de ocultar el overlay
        panel.addEventListener('transitionend', () => {
          if (panelO) {
            panelO.classList.remove('visible');
            panelO.classList.add('hidden');
          }
        }, { once: true }); // El listener se ejecuta solo una vez
      } else if (panelO) { // Fallback si panel no existe pero overlay sí
        panelO.classList.remove('visible');
        panelO.classList.add('hidden');
      }
    }

    function goToFormStep(){
      if (!cart.length) {
        showNotification('Agrega productos a la cotización primero.', 'bg-yellow-500 text-black');
        return;
      }
      closeCartPanel(); // Cierra el panel si está abierto
      if (step1) step1.classList.remove('active');
      if (step2) step2.classList.add('active');

      const pdfBtn = document.getElementById('generatePdfBtn');
      const whatsappBtn = document.getElementById('sendWhatsappBtn');
      if (pdfBtn) pdfBtn.disabled = false;
      if (whatsappBtn) whatsappBtn.disabled = false;
    }

    function backToCotizadorStep(){
      if (step2) step2.classList.remove('active');
      if (step1) step1.classList.add('active');
    }

    // --- Filtrado y Ordenamiento de Productos ---
    function applyFilters(){
      const k1 = (document.getElementById('filterKeyword1')?.value || '').toLowerCase();
      const k2 = (document.getElementById('filterKeyword2')?.value || '').toLowerCase();
      const k3 = (document.getElementById('filterKeyword3')?.value || '').toLowerCase();
      const min = parseFloat(document.getElementById('minPrice')?.value) || 0;
      const max = parseFloat(document.getElementById('maxPrice')?.value) || Infinity;
      const sortBy = document.getElementById('sortBy')?.value || 'name-asc';

      filteredProducts = products.filter(p => {
        const description = (p.Descripcion || '').toLowerCase();
        // CORREGIDO: Usa la función segura para obtener el precio
        const price = getSafePrice(p.PrecioPublico);

        const matchesKeyword1 = !k1 || description.includes(k1);
        const matchesKeyword2 = !k2 || description.includes(k2);
        const matchesKeyword3 = !k3 || description.includes(k3);
        const matchesPrice = price >= min && price <= max;

        return matchesKeyword1 && matchesKeyword2 && matchesKeyword3 && matchesPrice;
      });

      sortProducts(filteredProducts, sortBy);
      renderProducts(filteredProducts); // Llama a render después de filtrar y ordenar
    }

    function sortProducts(arrayToSort, sortBy){
      const [field, order] = sortBy.split('-');

      arrayToSort.sort((a, b) => {
        let comparison = 0;
        if (field === 'name') {
          const nameA = (a.Descripcion || '').toLowerCase();
          const nameB = (b.Descripcion || '').toLowerCase();
          comparison = nameA.localeCompare(nameB);
        } else if (field === 'price') {
          // CORREGIDO: Usa la función segura para obtener precios
          const priceA = getSafePrice(a.PrecioPublico);
          const priceB = getSafePrice(b.PrecioPublico);
          comparison = priceA - priceB;
        }

        return order === 'asc' ? comparison : (comparison * -1);
      });
    }

     // --- Renderizado de Productos ---
    function renderProducts(productsToRender){
      const container = document.getElementById('productsContainer');
      const noProductsMsg = document.getElementById('noProductsMessage');
      const paginationControls = document.getElementById('pagination');
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      if (!container || !noProductsMsg || !paginationControls || !pageInfo || !prevBtn || !nextBtn) {
          console.error("Error: No se encontraron elementos esenciales para renderizar productos.");
          return;
      }

      container.innerHTML = ''; // Limpiar contenedor

      const totalProducts = productsToRender.length;
      const totalPages = Math.ceil(totalProducts / itemsPerPage);

      // Validar currentPage
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;


      pageInfo.textContent = `Página ${totalPages > 0 ? currentPage : 0} de ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;


      if (totalProducts === 0) {
          noProductsMsg.classList.remove('hidden');
          paginationControls.classList.add('hidden');
          return; // Salir si no hay productos que mostrar
      } else {
          noProductsMsg.classList.add('hidden');
          paginationControls.classList.remove('hidden');
      }

      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageItems = productsToRender.slice(startIndex, endIndex);

      pageItems.forEach(product => {
        // CORREGIDO: Usa la función segura para obtener el precio
        const price = getSafePrice(product.PrecioPublico);
        const productInCart = cart.find(item => item.Clave === product.Clave);
        const quantityInCart = productInCart ? productInCart.quantity : 1; // Default a 1 si no está en carrito

        const card = document.createElement('div');
        card.className = 'product-card bg-white border rounded flex flex-col transition duration-200 ease-in-out';
        // Usar logo por defecto si no hay imagen específica del producto
        const imageUrl = product.imageUrl || companyInfo.logoUrl || 'placeholder.png'; // Añade un placeholder si logo tampoco existe

        card.innerHTML = `
          <div class="p-4 flex-grow">
            <div class="h-32 bg-gray-100 mb-4 flex items-center justify-center overflow-hidden rounded-md">
              <img src="${imageUrl}" alt="${product.Descripcion || 'Producto'}" class="object-contain h-full w-full"/>
            </div>
            <h3 class="font-semibold text-gray-800 mb-1 h-12 overflow-hidden text-ellipsis">${product.Descripcion || 'Sin descripción'}</h3>
            <p class="text-xs text-gray-500 mb-2">Clave: ${product.Clave || 'N/A'}</p>
          </div>
          <div class="p-4 border-t flex items-center">
            <span class="font-bold text-tpsDarkBlue mr-auto">$${price.toFixed(2)}</span>
            <input type="number" value="${quantityInCart}" min="1" class="quantity-input w-16 p-1 border rounded text-center mr-2 text-sm appearance-none" data-product-id="${product.Clave}"/>
            <button class="add-to-cart ${productInCart ? 'bg-gray-400 cursor-not-allowed' : 'bg-tpsOrange hover:bg-orange-600'} text-white py-1 px-3 rounded text-sm flex items-center justify-center w-[40px] h-[30px]" data-product-id="${product.Clave}" ${productInCart ? 'disabled' : ''}>
              ${productInCart ? '<i class="fas fa-check"></i>' : '<i class="fas fa-cart-plus"></i>'}
            </button>
          </div>`;
        container.appendChild(card);
      });

      // Añadir Event Listeners a los elementos recién creados DENTRO de renderProducts
       container.querySelectorAll('.add-to-cart').forEach(button => {
           button.addEventListener('click', (event) => {
               const btn = event.currentTarget;
               const productId = btn.dataset.productId;
               const quantityInput = btn.previousElementSibling;
               const quantity = parseInt(quantityInput.value, 10) || 1;

               if (productId) {
                   addToCart(productId, quantity);
                   // Actualizar UI del botón inmediatamente
                   btn.disabled = true;
                   btn.classList.remove('bg-tpsOrange', 'hover:bg-orange-600');
                   btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                   btn.innerHTML = '<i class="fas fa-check"></i>';
               }
           });
       });

       container.querySelectorAll('.quantity-input').forEach(input => {
           input.addEventListener('change', (event) => {
               const inputElem = event.currentTarget;
               const productId = inputElem.dataset.productId;
               const newQuantity = parseInt(inputElem.value, 10);

               // Validar cantidad
               if (isNaN(newQuantity) || newQuantity < 1) {
                   inputElem.value = 1; // Restablecer a 1 si no es válido
                   if (cart.some(item => item.Clave === productId)) {
                     updateCartItemQuantity(productId, 1);
                   }
                   showNotification("La cantidad debe ser al menos 1", "bg-yellow-500 text-black");
               } else {
                   // Solo actualiza si el producto YA ESTÁ en el carrito
                   if (cart.some(item => item.Clave === productId)) {
                       updateCartItemQuantity(productId, newQuantity);
                   }
                   // Si no está en el carrito, el botón "Añadir" se encargará.
               }
           });
       });
    }

    // --- Lógica del Carrito (Añadir, Actualizar, Limpiar) ---
    function addCustomProductToCart(){
      const descriptionInput = document.getElementById('customProductDescription');
      const priceInput = document.getElementById('customProductPrice');

      const description = descriptionInput?.value.trim();
      const priceValue = priceInput?.value;

      // Validaciones más robustas
      if (!description) {
          showNotification('La descripción del producto personalizado no puede estar vacía.', 'bg-yellow-500 text-black');
          descriptionInput?.focus();
          return;
      }
      if (priceValue === '' || priceValue === null || isNaN(parseFloat(priceValue)) || parseFloat(priceValue) < 0) {
          showNotification('El precio del producto personalizado es inválido o negativo.', 'bg-yellow-500 text-black');
          priceInput?.focus();
          return;
      }

      const price = parseFloat(priceValue); // Ya validado que es un número >= 0
      const uniqueId = `custom-${Date.now()}-${customProductCounter++}`;

      const newCustomItem = {
          Clave: uniqueId,
          Descripcion: description,
          PrecioPublico: price, // Guardamos como NÚMERO
          quantity: 1,
          isCustom: true
      };

      cart.push(newCustomItem);
      saveCart();
      updateCart(); // Actualiza la UI del panel del carrito
      if (customOverlay) customOverlay.classList.remove('visible'); // Cierra el modal
      showNotification('Producto personalizado agregado.', 'bg-green-600');

      // Limpiar campos del modal
       if(descriptionInput) descriptionInput.value = '';
       if(priceInput) priceInput.value = '';
    }

    function addToCart(productId, quantity = 1){
      if (quantity < 1) {
          showNotification("La cantidad debe ser al menos 1", "bg-yellow-500 text-black");
          return;
      }

      const existingCartItemIndex = cart.findIndex(item => item.Clave === productId);

      if (existingCartItemIndex > -1) {
          // Si ya existe, incrementa la cantidad (o actualiza si se pasó una cantidad específica)
          cart[existingCartItemIndex].quantity = quantity; // Cambiado de += a = para reflejar input
          showNotification('Cantidad actualizada en el carrito.', 'bg-blue-500');
      } else {
          // Si no existe, búscalo en la lista de productos cargados
          const productToAdd = products.find(p => p.Clave === productId);
          if (productToAdd) {
              cart.push({
                  ...productToAdd, // Copia todas las props del producto
                  quantity: quantity // Añade la cantidad
              });
              showNotification(`${productToAdd.Descripcion || 'Producto'} agregado al carrito.`, 'bg-green-600');
          } else {
              // No debería pasar si el botón está bien generado, pero por si acaso
              console.error(`Error: Producto con Clave ${productId} no encontrado.`);
              showNotification('Error: Producto no encontrado.', 'bg-red-600');
              return; // Detener si no se encontró el producto
          }
      }

      saveCart();
      updateCart(); // Actualiza visualmente el panel del carrito
      // No necesitamos re-renderizar los productos aquí, solo el panel y la burbuja
  }

    function updateCartItemQuantity(productId, newQuantity){
      const itemIndex = cart.findIndex(item => item.Clave === productId);

      if (itemIndex > -1) {
          if (newQuantity > 0) {
              cart[itemIndex].quantity = newQuantity;
          } else {
              // Si la cantidad es 0 o menos, elimina el item del carrito
              cart.splice(itemIndex, 1);
              showNotification('Producto eliminado del carrito.', 'bg-blue-500');
              // Necesitamos volver a renderizar la lista de productos para actualizar el botón Add/Check
              renderProducts(filteredProducts);
          }
          saveCart();
          updateCart(); // Actualiza el panel del carrito
      }
       // Si el item no se encontró en el carrito, no hagas nada (podría ser un input de un producto no añadido)
    }

    function clearCart(){
      if (!cart.length) return; // No hacer nada si ya está vacío

      // Usar un modal de confirmación más visual si es posible, sino alert/confirm
      if (confirm('¿Estás seguro de que quieres vaciar toda la cotización?')) {
          cart = [];
          saveCart();
          updateCart(); // Actualiza el panel (mostrará "vacío")
          renderProducts(filteredProducts); // Re-renderiza productos para resetear botones y cantidades
          showNotification('Cotización vaciada.', 'bg-green-600');
          // Resetear descuento global si se desea
          const discountInput = document.getElementById('globalDiscountPanel');
          if (discountInput) discountInput.value = 0;
      }
    }

    function updateCart(){
      const cartItemsContainer = document.getElementById('cartItemsPanel');
      const subtotalEl = document.getElementById('subtotalPanel');
      const discountAmountEl = document.getElementById('discountAmountPanel');
      const subtotalAfterDiscountEl = document.getElementById('subtotalAfterDiscountPanel');
      const taxEl = document.getElementById('taxPanel');
      const totalEl = document.getElementById('totalPanel');
      const discountInput = document.getElementById('globalDiscountPanel');

      if (!cartItemsContainer || !subtotalEl || !discountAmountEl || !subtotalAfterDiscountEl || !taxEl || !totalEl || !discountInput) {
          console.error("Error: Elementos del panel del carrito no encontrados.");
          return;
      }

      cartItemsContainer.innerHTML = ''; // Limpiar panel

      if (cart.length === 0) {
          cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center py-10">Tu cotización está vacía.</p>';
          subtotalEl.textContent = '$0.00';
          discountAmountEl.textContent = '-$0.00';
          subtotalAfterDiscountEl.textContent = '$0.00';
          taxEl.textContent = '$0.00';
          totalEl.textContent = '$0.00';
          if (nextBtn) nextBtn.disabled = true; // Deshabilitar botón 'Siguiente'
          updateCartBubbleCount(); // Actualiza la burbuja a 0
          return;
      }

      let currentSubtotal = 0;
      cart.forEach((item, index) => {
          // CORREGIDO: Usa la función segura para obtener el precio
          const price = getSafePrice(item.PrecioPublico);
          const itemTotal = price * item.quantity;
          currentSubtotal += itemTotal;

          const itemDiv = document.createElement('div');
          itemDiv.className = 'cart-item fade-in p-3 border-b flex justify-between items-start gap-2'; // `items-start` para mejor alineación si el texto es largo
          itemDiv.innerHTML = `
              <div class="flex items-center mr-2 flex-grow min-w-0"> <!-- Added min-w-0 for flex shrink/grow -->
                  <img src="${item.imageUrl || companyInfo.logoUrl || 'placeholder.png'}" alt="${item.Descripcion}" class="w-10 h-10 object-contain mr-3 rounded flex-shrink-0"/>
                  <div class="min-w-0"> <!-- Added min-w-0 here too -->
                      <h4 class="font-medium text-sm truncate" title="${item.Descripcion}">${item.Descripcion}</h4>
                      <p class="text-xs text-gray-500">$${price.toFixed(2)} c/u</p>
                  </div>
              </div>
              <div class="flex items-center flex-shrink-0">
                  <input type="number" value="${item.quantity}" min="1" class="cart-quantity-input w-16 p-1 border rounded text-center mr-2 text-sm appearance-none" data-item-index="${index}"/>
                  <span class="font-semibold mr-3 w-20 text-right">$${itemTotal.toFixed(2)}</span>
                  <button class="remove-item text-red-500 hover:text-red-700" data-item-index="${index}" title="Eliminar item">
                      <i class="fas fa-times"></i>
                  </button>
              </div>`;
          cartItemsContainer.appendChild(itemDiv);
      });

      // Calcular totales
      const globalDiscountPercent = parseFloat(discountInput.value) || 0;
      const discountAmount = currentSubtotal * (globalDiscountPercent / 100);
      const subtotalAfterDiscount = currentSubtotal - discountAmount;
      const taxAmount = subtotalAfterDiscount * 0.16; // Asumiendo IVA 16%
      const grandTotal = subtotalAfterDiscount + taxAmount;

      // Actualizar UI de totales
      subtotalEl.textContent = `$${currentSubtotal.toFixed(2)}`;
      discountAmountEl.textContent = `-$${discountAmount.toFixed(2)}`;
      subtotalAfterDiscountEl.textContent = `$${subtotalAfterDiscount.toFixed(2)}`;
      taxEl.textContent = `$${taxAmount.toFixed(2)}`;
      totalEl.textContent = `$${grandTotal.toFixed(2)}`;

      // Habilitar botón 'Siguiente'
      if (nextBtn) nextBtn.disabled = false;

      // Añadir listeners a los elementos recién creados en el panel
      cartItemsContainer.querySelectorAll('.remove-item').forEach(button => {
          button.addEventListener('click', (event) => {
              const indexToRemove = parseInt(event.currentTarget.dataset.itemIndex, 10);
              if (!isNaN(indexToRemove)) {
                  const removedItem = cart.splice(indexToRemove, 1)[0]; // Elimina del array
                  saveCart();
                  updateCart(); // Vuelve a dibujar el panel
                  // Si el item eliminado no era personalizado, re-renderiza los productos para habilitar su botón 'Add'
                  if (removedItem && !removedItem.isCustom) {
                      renderProducts(filteredProducts);
                  }
                   showNotification("Producto eliminado.", "bg-blue-500");
              }
          });
      });

      cartItemsContainer.querySelectorAll('.cart-quantity-input').forEach(input => {
          input.addEventListener('change', (event) => {
              const inputElem = event.currentTarget;
              const itemIndex = parseInt(inputElem.dataset.itemIndex, 10);
              const newQuantity = parseInt(inputElem.value, 10);

              if (!isNaN(itemIndex) && itemIndex < cart.length) {
                 if (isNaN(newQuantity) || newQuantity < 1) {
                    // Si la cantidad es inválida, eliminar el producto o poner 1? Optamos por eliminarlo.
                    inputElem.value = cart[itemIndex].quantity; // Revertir cambio en input
                    showNotification("Cantidad inválida. Para eliminar usa el botón (X) o pon 0.", "bg-yellow-500 text-black");
                    // Opcional: eliminar directamente si es < 1
                     /*
                    cart.splice(itemIndex, 1);
                    saveCart();
                    updateCart();
                    renderProducts(filteredProducts); // Podría necesitar rerender
                    showNotification("Producto eliminado por cantidad inválida.", "bg-blue-500");
                     */

                 } else {
                     cart[itemIndex].quantity = newQuantity;
                     saveCart();
                     updateCart(); // Actualiza totales y recalcula todo en el panel
                     // No es necesario re-renderizar lista de productos aquí
                 }
              }
          });
      });

      updateCartBubbleCount(); // Asegura que la burbuja esté sincronizada
    }


    // --- Calculadora de Mezclas ---
    function calcularMezcla(){
      const areaInput = document.getElementById('mezclaArea');
      const rendimientoInput = document.getElementById('mezclaRendimiento');
      const parteAInput = document.getElementById('mezclaParteA');
      const parteBInput = document.getElementById('mezclaParteB');
      const parteCInput = document.getElementById('mezclaParteC');
      const resultadoDiv = document.getElementById('mezclaResultado');
      const errorDiv = document.getElementById('mezclaError');
      const totalNecesariaP = document.getElementById('mezclaTotalNecesaria');
      const resultadoAP = document.getElementById('mezclaResultadoParteA');
      const resultadoBP = document.getElementById('mezclaResultadoParteB');
      const resultadoCP = document.getElementById('mezclaResultadoParteC');


      // Validar existencia de elementos
      if (!areaInput || !rendimientoInput || !parteAInput || !parteBInput || !parteCInput || !resultadoDiv || !errorDiv || !totalNecesariaP || !resultadoAP || !resultadoBP || !resultadoCP) {
          console.error("Error: Elementos de la calculadora no encontrados.");
          showMezclaError("Error interno. Faltan elementos de la calculadora.");
          return;
      }

      const area = parseFloat(areaInput.value);
      const rendimiento = parseFloat(rendimientoInput.value);
      const parteA = parseFloat(parteAInput.value) || 0; // Default a 0 si está vacío o inválido
      const parteB = parseFloat(parteBInput.value) || 0;
      const parteC = parseFloat(parteCInput.value) || 0;

      // Validaciones de entrada
      if (isNaN(area) || area <= 0) {
          showMezclaError("El área debe ser un número positivo.");
          areaInput.focus();
          return;
      }
      if (isNaN(rendimiento) || rendimiento <= 0) {
          showMezclaError("El rendimiento debe ser un número positivo.");
          rendimientoInput.focus();
          return;
      }
      if (parteA < 0 || parteB < 0 || parteC < 0) {
          showMezclaError("Las partes de la relación no pueden ser negativas.");
          return;
      }
      const sumaPartes = parteA + parteB + parteC;
      if (sumaPartes === 0) {
          showMezclaError("La suma de las partes de la relación no puede ser cero.");
          return;
      }

      // Calcular
      const totalLitrosNecesarios = area / rendimiento;
      const litrosPorUnidadDeRelacion = totalLitrosNecesarios / sumaPartes;

      // Mostrar resultados
      totalNecesariaP.textContent = `Total mezcla necesaria: ${totalLitrosNecesarios.toFixed(2)} L`;
      resultadoAP.textContent = `Componente A: ${(litrosPorUnidadDeRelacion * parteA).toFixed(2)} L`;
      resultadoBP.textContent = `Componente B: ${(litrosPorUnidadDeRelacion * parteB).toFixed(2)} L`;

      if (parteC > 0) {
          resultadoCP.textContent = `Componente C: ${(litrosPorUnidadDeRelacion * parteC).toFixed(2)} L`;
          resultadoCP.classList.remove('hidden');
      } else {
          resultadoCP.textContent = ''; // Limpiar por si acaso
          resultadoCP.classList.add('hidden');
      }

      // Mostrar div de resultados y ocultar error
      errorDiv.classList.add('hidden');
      resultadoDiv.classList.remove('hidden');
    }

    function showMezclaError(message){
      const errorDiv = document.getElementById('mezclaError');
      const errorMessageP = document.getElementById('mezclaErrorMessage');
      const resultadoDiv = document.getElementById('mezclaResultado');

      if (errorMessageP) errorMessageP.textContent = message;
      if (resultadoDiv) resultadoDiv.classList.add('hidden'); // Ocultar resultados anteriores
      if (errorDiv) errorDiv.classList.remove('hidden'); // Mostrar error
    }

    // --- Generación de PDF ---
    function generatePdf(){
      // Validar que hay items en el carrito
      if (cart.length === 0) {
          showNotification("No hay productos en la cotización para generar PDF.", "bg-yellow-500 text-black");
          return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Obtener datos del formulario (con valores por defecto)
      const prospectName = document.getElementById('prospectName')?.value.trim() || 'N/A';
      const prospectCompany = document.getElementById('prospectCompany')?.value.trim() || 'N/A';
      const projectName = document.getElementById('projectName')?.value.trim() || 'N/A';
      const salespersonName = document.getElementById('salespersonName')?.value.trim() || 'N/A';
      const salespersonPhone = document.getElementById('salespersonPhone')?.value.trim() || 'N/A';
      const salespersonEmail = document.getElementById('salespersonEmail')?.value.trim() || 'N/A';
      const globalDiscount = parseFloat(document.getElementById('globalDiscountPanel')?.value) || 0;

      // --- Intento de Carga de Logo ---
      const img = new Image();
      img.crossOrigin = 'Anonymous'; // Intentar evitar Tainted Canvas si el logo está en otro dominio
      img.onload = () => {
          try {
              // Calcular dimensiones manteniendo aspecto
              const aspectRatio = img.width / img.height;
              let imgWidth = 50;
              let imgHeight = imgWidth / aspectRatio;
              if (imgHeight > 25) {
                  imgHeight = 25;
                  imgWidth = imgHeight * aspectRatio;
              }
              // Añadir imagen
              doc.addImage(img, 'PNG', 195 - imgWidth, 10, imgWidth, imgHeight); // Ajustar posición a la derecha
          } catch (e) {
              console.error("Error al añadir imagen al PDF:", e);
              showNotification('Error añadiendo logo al PDF.', 'bg-red-600');
          } finally {
              // Continuar añadiendo el resto del contenido SIEMPRE
              addPdfContent(doc, prospectName, prospectCompany, projectName, salespersonName, salespersonPhone, salespersonEmail, globalDiscount);
              doc.save(`Cotizacion_${prospectName.replace(/ /g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
              showNotification('PDF generado.', 'bg-green-600');
          }
      };
      img.onerror = () => {
          console.warn("No se pudo cargar el logo para el PDF.");
          showNotification('PDF generado (sin logo).', 'bg-yellow-500 text-black');
          // Continuar sin el logo
          addPdfContent(doc, prospectName, prospectCompany, projectName, salespersonName, salespersonPhone, salespersonEmail, globalDiscount);
          doc.save(`Cotizacion_${prospectName.replace(/ /g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
      };

      // Asignar src DESPUÉS de definir onload/onerror
      img.src = companyInfo.logoUrl || 'logotps.png'; // Usar URL del objeto o default
    }

    function addPdfContent(doc, prospectName, prospectCompany, projectName, salespersonName, salespersonPhone, salespersonEmail, globalDiscount){
        const pageHeight = doc.internal.pageSize.height;
        const pageWidth = doc.internal.pageSize.width;
        const margin = 14;
        let currentY = 15; // Posición Y inicial

        // --- Información de la Empresa ---
        doc.setFontSize(16);
        doc.setTextColor(tpsDarkBlue); // Usando el color definido en Tailwind config
        doc.setFont('helvetica', 'bold');
        doc.text(companyInfo.name, margin, currentY);
        currentY += 8;

        doc.setFontSize(9);
        doc.setTextColor(100); // Gris
        doc.setFont('helvetica', 'normal');
        if(companyInfo.address) { doc.text(`Dirección: ${companyInfo.address}`, margin, currentY); currentY += 4; }
        if(companyInfo.phone) { doc.text(`Teléfono: ${companyInfo.phone}`, margin, currentY); currentY += 4; }
        if(companyInfo.email) { doc.text(`Email: ${companyInfo.email}`, margin, currentY); currentY += 8; }


        // --- Línea divisoria ---
        // doc.setDrawColor(200);
        // doc.line(margin, currentY, pageWidth - margin, currentY);
        // currentY += 8;

        // --- Datos del Prospecto y Vendedor (lado izquierdo) ---
        const prospectBoxY = currentY; // Guardar Y para la caja de vendedor
        doc.setFontSize(11);
        doc.setTextColor(tpsDarkBlue);
        doc.setFont('helvetica', 'bold');
        doc.text('Cliente:', margin, currentY);
        currentY += 5;

        doc.setFontSize(9);
        doc.setTextColor(0); // Negro
        doc.setFont('helvetica', 'normal');
        doc.text(`Nombre: ${prospectName}`, margin, currentY); currentY += 4;
        doc.text(`Empresa: ${prospectCompany}`, margin, currentY); currentY += 4;
        doc.text(`Proyecto: ${projectName}`, margin, currentY); currentY += 8; // Espacio extra


        // --- Datos del Vendedor (lado derecho) ---
        currentY = prospectBoxY; // Resetear Y a la misma altura que "Cliente"
        const sellerX = pageWidth / 2 + 5; // Empezar un poco después de la mitad

        doc.setFontSize(11);
        doc.setTextColor(tpsDarkBlue);
        doc.setFont('helvetica', 'bold');
        doc.text('Vendedor:', sellerX, currentY);
        currentY += 5;

        doc.setFontSize(9);
        doc.setTextColor(0); // Negro
        doc.setFont('helvetica', 'normal');
        doc.text(`Nombre: ${salespersonName}`, sellerX, currentY); currentY += 4;
        doc.text(`Tel: ${salespersonPhone}`, sellerX, currentY); currentY += 4;
        doc.text(`Email: ${salespersonEmail}`, sellerX, currentY); currentY += 4;
        doc.text(`Fecha: ${new Date().toLocaleDateString()}`, sellerX, currentY);

        // Asegurarse de que Y esté por debajo de la caja más alta
        currentY = Math.max(currentY, prospectBoxY + 21) + 10; // Ajustar según sea necesario


        // --- Título de la Tabla ---
        doc.setFontSize(14);
        doc.setTextColor(tpsDarkBlue);
        doc.setFont('helvetica', 'bold');
        doc.text('Detalle de la Cotización', pageWidth / 2, currentY, { align: 'center' });
        currentY += 10;

        // --- Preparación de Datos para AutoTable ---
        let subtotal = 0;
        const tableBody = cart.map(item => {
            // CORREGIDO: Usa la función segura para obtener el precio
            const price = getSafePrice(item.PrecioPublico);
            const itemTotal = price * item.quantity;
            subtotal += itemTotal;

            return [
                item.Descripcion || 'N/A', // Producto
                // Añadir columnas Presentación/Color si existen en tus datos
                // 'Pres.' || 'N/A', // Ejemplo: Presentación
                // 'Color' || 'N/A', // Ejemplo: Color
                `$${price.toFixed(2)}`,    // Precio Unitario
                item.quantity,              // Cantidad
                `$${itemTotal.toFixed(2)}` // Total
            ];
        });

        // Cálculos de Totales
        const discountAmount = subtotal * (globalDiscount / 100);
        const subtotalAfterDiscount = subtotal - discountAmount;
        const taxAmount = subtotalAfterDiscount * 0.16;
        const grandTotal = subtotalAfterDiscount + taxAmount;

        // Añadir filas de totales al cuerpo de la tabla
        const totalsRows = [
            [{ content: 'Subtotal:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, `$${subtotal.toFixed(2)}`] // Ajusta colSpan según columnas
        ];
        if (globalDiscount > 0) {
            totalsRows.push([{ content: `Descuento (${globalDiscount}%):`, colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, { content: `-$${discountAmount.toFixed(2)}`, styles: { textColor: [220, 38, 38] } }]); // Rojo para descuento
            totalsRows.push([{ content: 'Subtotal c/Desc.:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, `$${subtotalAfterDiscount.toFixed(2)}`]);
        }
        totalsRows.push([{ content: 'IVA (16%):', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } }, `$${taxAmount.toFixed(2)}`]);
        totalsRows.push([{ content: 'Total:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fontSize: 10 } }, { content: `$${grandTotal.toFixed(2)}`, styles: { fontStyle: 'bold', fontSize: 10, textColor: [0, 0, 0] } }]); // Negro y más grande para total

        // --- Generación de la Tabla ---
        doc.autoTable({
            startY: currentY,
            head: [['Producto', /*'Pres.', 'Color',*/ 'Precio Unitario', 'Cantidad', 'Total']], // Ajusta las cabeceras
            body: tableBody,
            foot: totalsRows, // Usar foot para los totales
            theme: 'grid', // 'striped', 'grid', 'plain'
            headStyles: {
                fillColor: [2, 48, 71], // tpsDarkBlue
                textColor: 255, // Blanco
                fontStyle: 'bold',
                halign: 'center'
            },
            footStyles: {
                fillColor: [240, 240, 240], // Un gris claro para el pie
                textColor: 0, // Negro
                fontStyle: 'bold'
            },
            styles: {
                cellPadding: 2,
                fontSize: 8,
                valign: 'middle'
            },
            columnStyles: {
                0: { cellWidth: 'auto' }, // Producto (ancho automático)
                //1: { cellWidth: 20, halign: 'center' }, // Pres.
                //2: { cellWidth: 20, halign: 'center' }, // Color
                1: { cellWidth: 30, halign: 'right' }, // Precio Unitario
                2: { cellWidth: 20, halign: 'center' }, // Cantidad
                3: { cellWidth: 30, halign: 'right' }  // Total
            },
            didDrawPage: (data) => {
                // Footer en cada página
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Página ${doc.internal.getNumberOfPages()}`, data.settings.margin.left, pageHeight - 10);
                doc.text('Generado por TPS Recubrimientos', pageWidth / 2, pageHeight - 10, { align: 'center' });
            },
            margin: { top: 10, bottom: 20 } // Margen inferior para el footer
        });

        // --- Notas Finales ---
        currentY = doc.lastAutoTable.finalY + 10; // Posición después de la tabla

        doc.setFontSize(8);
        doc.setTextColor(100);
        const finalNotes = [
            `• Esta cotización tiene una validez de 30 días a partir de la fecha de emisión (${new Date().toLocaleDateString()}).`,
            "• Los precios están expresados en MXN (Pesos Mexicanos) y no incluyen gastos de envío.",
            "• Precios y existencias sujetos a cambio sin previo aviso.",
            "• Para cualquier duda o aclaración, contacte a su vendedor.",
            // Añade más términos y condiciones si es necesario
        ];

        finalNotes.forEach(note => {
            if (currentY > pageHeight - 25) { // Checar si hay espacio antes de escribir
                doc.addPage();
                currentY = 20; // Posición Y en nueva página
            }
            doc.text(note, margin, currentY);
            currentY += 5;
        });
    }


    // --- Envío por WhatsApp ---
    function sendWhatsappQuote(){
      const prospectPhoneInput = document.getElementById('prospectPhone');
      const prospectNameInput = document.getElementById('prospectName');
      const salespersonNameInput = document.getElementById('salespersonName');
      const salespersonPhoneInput = document.getElementById('salespersonPhone');
      const discountInput = document.getElementById('globalDiscountPanel');

      if (!prospectPhoneInput || !prospectNameInput || !salespersonNameInput || !salespersonPhoneInput || !discountInput) {
          console.error("Error: Faltan elementos para generar mensaje de WhatsApp.");
          showNotification("Error interno al preparar mensaje.", "bg-red-600");
          return;
      }

      const prospectPhoneNumber = prospectPhoneInput.value.trim();
      if (!prospectPhoneNumber) {
          showNotification('Ingresa el número de teléfono (WhatsApp) del prospecto.', 'bg-yellow-500 text-black');
          prospectPhoneInput.focus();
          return;
      }
      if (cart.length === 0) {
          showNotification('No hay productos en la cotización para enviar.', 'bg-yellow-500 text-black');
          return;
      }

      // Limpiar y formatear número de teléfono
      let formattedPhone = prospectPhoneNumber.replace(/[\s\-()]/g, ''); // Eliminar espacios, guiones, paréntesis
       if (!formattedPhone.startsWith('+')) {
           // Asumir México si no tiene código de país, ajustar si es necesario
           if (formattedPhone.length === 10) {
               formattedPhone = '+52' + formattedPhone;
           } else {
               // Podría ser inválido, pero intentamos de todos modos
               console.warn("Número de teléfono sin código de país detectado:", formattedPhone);
               // Considera mostrar una advertencia más específica o validación
           }
       }


      // Construir mensaje
      const prospectName = prospectNameInput.value.trim() || 'Estimado Cliente';
      let message = `¡Hola ${prospectName}!\n\n`;
      message += `Aquí tienes la cotización solicitada de *${companyInfo.name}*:\n\n`;

      let currentSubtotal = 0;
      cart.forEach(item => {
          // CORREGIDO: Usa la función segura para obtener el precio
          const price = getSafePrice(item.PrecioPublico);
          const itemTotal = price * item.quantity;
          currentSubtotal += itemTotal;
          message += `- ${item.Descripcion} (${item.quantity} x $${price.toFixed(2)}): *$${itemTotal.toFixed(2)}*\n`;
      });

      // Calcular totales
      const globalDiscountPercent = parseFloat(discountInput.value) || 0;
      const discountAmount = currentSubtotal * (globalDiscountPercent / 100);
      const subtotalAfterDiscount = currentSubtotal - discountAmount;
      const taxAmount = subtotalAfterDiscount * 0.16;
      const grandTotal = subtotalAfterDiscount + taxAmount;

      message += `\n*Subtotal:* $${currentSubtotal.toFixed(2)}`;
      if (globalDiscountPercent > 0) {
          message += `\n*Descuento (${globalDiscountPercent}%):* -$${discountAmount.toFixed(2)}`;
          message += `\n*Subtotal c/Desc.:* $${subtotalAfterDiscount.toFixed(2)}`;
      }
      message += `\n*IVA (16%):* $${taxAmount.toFixed(2)}`;
      message += `\n*Total a pagar:* *$${grandTotal.toFixed(2)} MXN*\n`; // Enfatizar total

      message += "\n_(Precios sujetos a cambio sin previo aviso. Validez: 30 días.)_\n";

      const salespersonName = salespersonNameInput.value.trim();
      const salespersonPhone = salespersonPhoneInput.value.trim();
      if (salespersonName || salespersonPhone) {
          message += `\n*Atendido por:* ${salespersonName || ''} ${salespersonPhone ? `(${salespersonPhone})` : ''}`;
      }

      // Codificar y abrir WhatsApp
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;

      window.open(whatsappUrl, '_blank');
      showNotification('Abriendo WhatsApp...', 'bg-blue-500');
    }


    // --- Notificaciones ---
    let notificationTimeout;
    function showNotification(message, bgColor = 'bg-green-600'){
        const existingNotification = document.getElementById('toast-notification');
        if(existingNotification) {
            clearTimeout(notificationTimeout); // Limpia timeout anterior si existe
            existingNotification.remove(); // Remueve la notificación existente
        }

        const notificationDiv = document.createElement('div');
        notificationDiv.id = 'toast-notification';
        // Clases base + color dinámico + animación
        notificationDiv.className = `fixed bottom-4 right-4 text-white px-4 py-3 rounded-md shadow-lg flex items-center text-sm z-[1200] transition-all duration-300 ease-in-out transform translate-y-full opacity-0 ${bgColor}`;
        notificationDiv.innerHTML = `
            <i class="fas fa-info-circle mr-2"></i>
            <span>${message}</span>
            <button class="ml-auto pl-2 text-xl leading-none">×</button>
        `;

        document.body.appendChild(notificationDiv);

        // Listener para cerrar la notificación
        notificationDiv.querySelector('button').addEventListener('click', () => {
             clearTimeout(notificationTimeout);
             notificationDiv.classList.remove('translate-y-0', 'opacity-100');
             notificationDiv.classList.add('translate-y-full', 'opacity-0');
             setTimeout(() => notificationDiv.remove(), 300); // Remover del DOM tras animación de salida
        });


        // Animación de entrada
        setTimeout(() => {
            notificationDiv.classList.remove('translate-y-full', 'opacity-0');
            notificationDiv.classList.add('translate-y-0', 'opacity-100');
        }, 50); // Pequeño delay para asegurar que la transición ocurra


        // Autocierre después de 5 segundos
        notificationTimeout = setTimeout(() => {
            notificationDiv.querySelector('button').click(); // Simula click en el botón de cerrar
        }, 5000);
    }

  </script>
</body>
</html>
