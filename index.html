<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador TPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tpsDarkBlue: '#023047',
            tpsOrange:   '#fb8500',
            tpsWhite:    '#ffffff',
          }
        }
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Estilos esenciales (sin cambios) */
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
    .custom-scrollbar::-webkit-scrollbar { width:6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background:#888; border-radius:3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background:#555; }
    .floating-cart-bubble {
      position:fixed; bottom:20px; left:20px;
      background:#023047; color:#fff; border-radius:50%;
      width:60px; height:60px; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:transform .3s; z-index:1000;
    }
    .floating-cart-bubble:hover { transform:scale(1.1); }
    .floating-cart-bubble .cart-count {
      position:absolute; top:-5px; right:-5px;
      background:#fb8500; color:#fff; font-size:.75rem;
      font-weight:bold; padding:2px 6px; border-radius:9999px;
    }
    .cart-panel-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; justify-content:end;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s;
    }
    .cart-panel-overlay.visible { visibility:visible; opacity:1; }
    .cart-panel {
      background:#fff; width:90%; max-width:400px; height:100%;
      box-shadow:-4px 0 12px rgba(0,0,0,0.2);
      display:flex; flex-direction:column; transform:translateX(100%);
      transition:transform .3s;
    }
    .cart-panel.open { transform:translateX(0); }
    .cart-panel-header, .cart-panel-footer { padding:1rem; border-color:#e5e7eb; }
    .cart-panel-header { border-bottom:1px solid; display:flex; justify-content:space-between; align-items:center; }
    .cart-panel-body { flex-grow:1; overflow-y:auto; padding:1rem; }
    .step { display:none; }
    .step.active { display:block; }
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s; z-index:1100;
    }
    .modal-overlay.visible { visibility:visible; opacity:1; }
    .modal {
      background:#fff; padding:1.5rem; border-radius:.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      width:90%; max-width:400px; transform:translateY(-20px);
      transition:transform .3s;
    }
    .modal-overlay.visible .modal { transform:translateY(0); }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <div class="container mx-auto px-4 py-8">
    <!-- Header (sin cambios) -->
    <header class="mb-10 flex flex-col sm:flex-row items-center justify-center">
      <img src="logotps.png" alt="Logo TPS" class="h-16 mb-4 sm:mb-0 sm:mr-4"/>
      <div>
        <h1 class="text-4xl font-bold text-center text-tpsDarkBlue mb-2">Cotizador TPS</h1>
        <p class="text-center text-gray-600">Genera cotizaciones rápidas</p>
      </div>
      <button id="openCalculatorModalBtn" class="ml-0 sm:ml-6 mt-4 sm:mt-0 bg-tpsOrange text-tpsWhite py-2 px-4 rounded-md hover:bg-orange-600 flex items-center text-sm">
        <i class="fas fa-calculator mr-2"></i> Calculadora
      </button>
    </header>

    <div id="appContainer" class="relative">
      <!-- Paso 1 (sin cambios en estructura) -->
      <div id="step1" class="step active">
        <!-- Filtros ... (igual que antes) -->
      </div>

      <!-- Paso 2 (sin cambios en estructura) -->
      <div id="step2" class="step">
        <!-- Formulario ... (igual que antes) -->
      </div>
    </div>
  </div>

  <!-- Carrito flotante, panel, modales ... (idénticos) -->

  <!-- Modal calculadora -->
  <div id="calculatorModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-6">
        <h3 class="font-semibold">Calculadora Mezclas</h3>
        <button id="closeCalculatorModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <input id="mezclaArea" type="number" step="0.01" placeholder="Área m²" class="border p-2 rounded"/>
        <input id="mezclaRendimiento" type="number" step="0.01" placeholder="Rend m²/L" class="border p-2 rounded"/>
      </div>
      <div class="mb-6">
        <!-- 🚀 Label actualizado aquí: -->
        <label class="block mb-1">Relación PARTE A : PARTE B : REDUCTOR</label>
        <div class="flex items-center space-x-2">
          <input id="mezclaParteA" type="number" value="4" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteB" type="number" value="1" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteC" type="number" value="0" min="0" class="w-1/3 p-2 border rounded text-center"/>
        </div>
      </div>
      <button id="calcularMezclaBtn" class="w-full bg-tpsDarkBlue text-white py-2 rounded flex items-center justify-center mb-6">
        <i class="fas fa-calculator mr-2"></i> Calcular
      </button>
      <div id="mezclaResultado" class="hidden p-4 bg-gray-100 rounded mb-4">
        <p id="mezclaTotalNecesaria" class="mb-2"></p>
        <p id="mezclaResultadoParteA" class="mb-2"></p>
        <p id="mezclaResultadoParteB" class="mb-2"></p>
        <p id="mezclaResultadoParteC"></p>
      </div>
      <div id="mezclaError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <p id="mezclaErrorMessage"></p>
      </div>
    </div>
  </div>

  <script>
    // Datos de empresa
    const companyInfo = {
      name:    "TPS Recubrimientos",
      address: "Calle Ficticia #123",
      phone:   "55 1234 5678",
      email:   "contacto@tpsrecubrimientos.com",
      logoUrl: "logotps.png"
    };

    // Carrito y productos
    let products = [], cart = [], filteredProducts = [], customProductCounter = 0;
    const itemsPerPage = 9; let currentPage = 1;

    // ---------- UTILIDADES ----------

    // Formateo de moneda con separador de miles
    const fmtNum = n => n.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtMon = n => n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

    // Función para convertir números a letras (en español)
    function numeroALetras(num) {
      const unidades = ['cero','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve',
                        'diez','once','doce','trece','catorce','quince','dieciseis','diecisiete','dieciocho','diecinueve','veinte'];
      if (num <= 20) return unidades[num];
      if (num < 100) {
        const decs = ['','','veinti','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
        let d = Math.floor(num/10), u = num % 10;
        return decs[d] + (u ? (d>2?' y ':'') + unidades[u] : '');
      }
      if (num < 1000) {
        const c = Math.floor(num/100), r = num % 100;
        return (c>1?unidades[c]:'') + 'ciento' + (r?' '+ numeroALetras(r):'');
      }
      if (num < 1000000) {
        const m = Math.floor(num/1000), r = num % 1000;
        return (m>1?numeroALetras(m)+' mil':'mil') + (r?' '+numeroALetras(r):'');
      }
      if (num < 1000000000000) {
        const mill = Math.floor(num/1000000), r = num % 1000000;
        return (mill>1?numeroALetras(mill)+' millones':'un millón') + (r?' '+numeroALetras(r):'');
      }
      return num.toString();
    }

    // Safe price parse
    function getSafePrice(val) {
      return parseFloat(String(val||'0').replace(',', '.'))||0;
    }

    // ---------- INICIALIZACIÓN ----------
    document.addEventListener('DOMContentLoaded',()=>{
      loadProducts();
      setupEventListeners();
      loadCart();
      updateCart();
      updateCartBubbleCount();
    });

    // ... aquí irían loadProducts(), setupEventListeners(), loadCart() sin cambios ...

    // ---------- RENDER PRODUCTOS ----------
    function renderProducts(productsToRender){
      const container = document.getElementById('productsContainer');
      // ... validaciones ...
      container.innerHTML = '';
      const start = (currentPage-1)*itemsPerPage;
      const end = start+itemsPerPage;
      productsToRender.slice(start,end).forEach(p=>{
        const price = getSafePrice(p.PrecioPublico);
        const priceFmt = fmtMon(price);
        const card = document.createElement('div');
        card.className = 'product-card bg-white border rounded flex flex-col';
        card.innerHTML = `
          <div class="p-4 flex-grow">
            <h3 class="font-semibold text-gray-800 mb-1">${p.Descripcion}</h3>
          </div>
          <div class="p-4 border-t flex items-center">
            <span class="font-bold text-tpsDarkBlue mr-auto">${priceFmt}</span>
            <input type="number" value="1" min="1" class="quantity-input w-16 p-1 border rounded text-center mr-2" data-product-id="${p.Clave}"/>
            <button class="add-to-cart bg-tpsOrange text-white py-1 px-3 rounded" data-product-id="${p.Clave}">
              <i class="fas fa-cart-plus"></i>
            </button>
          </div>`;
        container.appendChild(card);
      });
      // ... paginación, listeners, etc. ...
    }

    // ---------- ACTUALIZAR CARRITO EN PANTALLA ----------
    function updateCart(){
      const panel = document.getElementById('cartItemsPanel');
      // ... limpiar, validar ...
      let subtotal = 0;
      cart.forEach(item=>{
        const price = getSafePrice(item.PrecioPublico);
        const totalItem = price*item.quantity;
        subtotal += totalItem;
        // construir cada línea con fmtMon(...)
      });
      const discountPct = parseFloat(document.getElementById('globalDiscountPanel').value)||0;
      const discountAmt = subtotal * discountPct/100;
      const subDesc = subtotal - discountAmt;
      const iva = subDesc * 0.16;
      const granTotal = subDesc + iva;

      // Actualizar totales en UI con separadores
      document.getElementById('subtotalPanel').textContent           = fmtMon(subtotal);
      document.getElementById('discountAmountPanel').textContent     = '- ' + fmtMon(discountAmt);
      document.getElementById('subtotalAfterDiscountPanel').textContent = fmtMon(subDesc);
      document.getElementById('taxPanel').textContent                = fmtMon(iva);
      document.getElementById('totalPanel').textContent              = fmtMon(granTotal);

      // ... listeners de cantidad y borrar ...
    }

    // ---------- GENERAR PDF ----------
    function generatePdf(){
      if (!cart.length) { alert('Agrega productos'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      // Función helper para formatear en PDF:
      const fmt = n => n.toLocaleString('es-MX',{ style:'currency', currency:'MXN' });
      // Datos de formulario...
      // Carga de logo (igual)...

      // Contenido de empresa, cliente, vendedor (igual)...

      // Preparar tabla:
      let subtotal = 0;
      const body = cart.map(item=>{
        const price = getSafePrice(item.PrecioPublico);
        const total = price*item.quantity;
        subtotal += total;
        return [
          item.Descripcion,
          fmt(price),
          item.quantity,
          fmt(total)
        ];
      });
      // Cálculos:
      const discountPct = parseFloat(document.getElementById('globalDiscountPanel').value)||0;
      const discountAmt = subtotal*discountPct/100;
      const subDesc = subtotal - discountAmt;
      const iva = subDesc*0.16;
      const granTotal = subDesc + iva;

      // Footers con colSpan:3 para alinear en la 4ª columna
      const foot = [];
      foot.push([
        { content:'Subtotal:',      colSpan:3, styles:{ halign:'right', fontStyle:'bold' } },
        { content: fmt(subtotal),   styles:{ halign:'right' } }
      ]);
      if (discountPct>0) {
        foot.push([
          { content:`Descuento (${discountPct}%):`, colSpan:3, styles:{ halign:'right', fontStyle:'bold', textColor:[220,38,38] } },
          { content:`- ${fmt(discountAmt)}`, styles:{ halign:'right', textColor:[220,38,38] } }
        ]);
        foot.push([
          { content:'Subtotal c/Desc.:', colSpan:3, styles:{ halign:'right', fontStyle:'bold' } },
          { content: fmt(subDesc), styles:{ halign:'right' } }
        ]);
      }
      foot.push([
        { content:'IVA (16%):',       colSpan:3, styles:{ halign:'right', fontStyle:'bold' } },
        { content: fmt(iva),          styles:{ halign:'right' } }
      ]);
      foot.push([
        { content:'Total:',           colSpan:3, styles:{ halign:'right', fontStyle:'bold', fontSize:10 } },
        { content: fmt(granTotal),    styles:{ halign:'right', fontStyle:'bold', fontSize:10 } }
      ]);

      // Generación de la tabla
      doc.autoTable({
        startY: 90,
        head: [['Producto','Precio Unitario','Cantidad','Total']],
        body,
        foot,
        theme:'grid',
        headStyles:{ fillColor:[2,48,71], textColor:255, fontStyle:'bold' },
        footStyles:{ fillColor:[240,240,240], textColor:0, fontStyle:'bold' },
        styles:{ fontSize:8, cellPadding:2 },
        columnStyles:{
          0:{ cellWidth: 60 },
          1:{ halign:'right', cellWidth:30 },
          2:{ halign:'center', cellWidth:20 },
          3:{ halign:'right', cellWidth:30 }
        }
      });

      // Total en letra debajo de la tabla
      const totalEnLetras = numeroALetras(Math.floor(granTotal)) +
        ' pesos ' + String(Math.round((granTotal%1)*100)).padStart(2,'0') + '/100 M.N.';
      doc.text(`Total en letra: ${totalEnLetras}`, 14, doc.lastAutoTable.finalY + 10);

      doc.save(`Cotizacion_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // ... resto de funciones: sendWhatsappQuote(), calcularMezcla(), showNotification(), etc., idénticas ...
  </script>
</body>
</html>
