<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador TPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tpsDarkBlue: '#023047',
            tpsOrange: '#fb8500',
            tpsWhite: '#ffffff',
          }
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Estilos personalizados */
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform: translateY(0);} }
    .custom-scrollbar::-webkit-scrollbar { width:6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background:#888; border-radius:3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background:#555; }
    .floating-cart-bubble {
      position:fixed; bottom:20px; left:20px;
      background:#023047; color:#fff; border-radius:50%;
      width:60px; height:60px; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:transform .3s; z-index:1000;
    }
    .floating-cart-bubble:hover { transform:scale(1.1); }
    .floating-cart-bubble .cart-count {
      position:absolute; top:-5px; right:-5px;
      background:#fb8500; color:#fff; font-size:.75rem;
      font-weight:bold; padding:2px 6px; border-radius:9999px;
    }
    .cart-panel-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; justify-content:end;
      visibility:hidden; opacity:0;
      transition:visibility .3s,opacity .3s;
    }
    .cart-panel-overlay.visible { visibility:visible; opacity:1; }
    .cart-panel {
      background:#fff; width:90%; max-width:400px; height:100%;
      box-shadow:-4px 0 12px rgba(0,0,0,0.2);
      display:flex; flex-direction:column; transform:translateX(100%);
      transition:transform .3s;
    }
    .cart-panel.open { transform:translateX(0); }
    .cart-panel-header, .cart-panel-footer { padding:1rem; border-color:#e5e7eb; }
    .cart-panel-header { border-bottom:1px solid; display:flex; justify-content:space-between; align-items:center; }
    .cart-panel-body { flex-grow:1; overflow-y:auto; padding:1rem; }
    .step { display:none; }
    .step.active { display:block; }
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex;
      align-items:center; justify-content:center;
      visibility:hidden; opacity:0;
      transition:visibility .3s,opacity .3s;
      z-index:1100;
    }
    .modal-overlay.visible { visibility:visible; opacity:1; }
    .modal {
      background:#fff; padding:1.5rem; border-radius:.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      width:90%; max-width:400px;
      transform:translateY(-20px);
      transition:transform .3s;
    }
    .modal-overlay.visible .modal { transform:translateY(0); }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-10 flex flex-col sm:flex-row items-center justify-center">
      <img src="logotps.png" alt="Logo TPS" class="h-16 mb-4 sm:mb-0 sm:mr-4"/>
      <div>
        <h1 class="text-4xl font-bold text-center text-tpsDarkBlue mb-2">Cotizador TPS</h1>
        <p class="text-center text-gray-600">Genera cotizaciones rápidas para prospectos</p>
      </div>
      <button id="openCalculatorModalBtn"
        class="ml-0 sm:ml-6 mt-4 sm:mt-0 bg-tpsOrange text-tpsWhite py-2 px-4 rounded-md hover:bg-orange-600 transition duration-300 flex items-center text-sm">
        <i class="fas fa-calculator mr-2"></i> Calculadora de Mezclas
      </button>
    </header>

    <!-- Aplicación -->
    <div id="appContainer" class="relative">

      <!-- Paso 1: Filtros y Productos -->
      <div id="step1" class="step active">
        <!-- Filtros -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
          <h2 class="text-xl font-semibold mb-4 text-gray-800">Filtros de Productos</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Palabra clave 1</label>
              <input id="filterKeyword1" class="w-full p-2 border rounded-md" placeholder="Ej: Epoxico"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Palabra clave 2</label>
              <input id="filterKeyword2" class="w-full p-2 border rounded-md" placeholder="Ej: Blanco"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Palabra clave 3</label>
              <input id="filterKeyword3" class="w-full p-2 border rounded-md" placeholder="Ej: Galón"/>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Rango de precios</label>
              <div class="flex items-center space-x-2">
                <input id="minPrice" type="number" class="w-1/2 p-2 border rounded-md" placeholder="Mínimo"/>
                <span>-</span>
                <input id="maxPrice" type="number" class="w-1/2 p-2 border rounded-md" placeholder="Máximo"/>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
              <select id="sortBy" class="w-full p-2 border rounded-md">
                <option value="name-asc">Nombre (A-Z)</option>
                <option value="name-desc">Nombre (Z-A)</option>
                <option value="price-asc">Precio (Menor a Mayor)</option>
                <option value="price-desc">Precio (Mayor a Menor)</option>
              </select>
            </div>
            <button id="applyFilters"
              class="w-full bg-tpsDarkBlue text-tpsWhite py-2 px-4 rounded-md hover:bg-gray-800 transition duration-300 flex items-center justify-center">
              <i class="fas fa-filter mr-2"></i> Aplicar Filtros
            </button>
          </div>
        </div>

        <!-- Productos -->
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-800">Productos Disponibles</h2>
            <button id="openCustomProductModalBtn"
              class="bg-tpsOrange text-tpsWhite py-2 px-4 rounded-md hover:bg-orange-600 flex items-center text-sm">
              <i class="fas fa-plus-circle mr-2"></i> Producto Personalizado
            </button>
          </div>
          <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p class="text-center text-gray-500">Cargando productos...</p>
          </div>
          <div id="noProductsMessage" class="hidden text-center py-10">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-3"></i>
            <p class="text-gray-500">No se encontraron productos</p>
          </div>
          <div id="pagination" class="flex justify-center items-center mt-6 space-x-4">
            <button id="prevPageBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md disabled:opacity-50">
              <i class="fas fa-arrow-left mr-2"></i> Anterior
            </button>
            <span id="pageInfo" class="text-gray-700">Página 1 de 1</span>
            <button id="nextPageBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md disabled:opacity-50">
              Siguiente <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Paso 2: Datos y Generación -->
      <div id="step2" class="step">
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-xl font-semibold mb-6 text-gray-800">Datos de Cotización y Envío</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Nombre Prospecto</label>
              <input id="prospectName" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Empresa Prospecto</label>
              <input id="prospectCompany" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Proyecto</label>
              <input id="projectName" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Teléfono (WhatsApp)</label>
              <input id="prospectPhone" type="tel" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Nombre Vendedor</label>
              <input id="salespersonName" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Teléfono Vendedor</label>
              <input id="salespersonPhone" class="w-full p-2 border rounded-md"/></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Correo Vendedor</label>
              <input id="salespersonEmail" type="email" class="w-full p-2 border rounded-md"/></div>
          </div>
          <div class="mt-6 flex flex-col sm:flex-row justify-between items-center">
            <button id="backToCart"
              class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 mb-4 sm:mb-0 flex items-center">
              <i class="fas fa-arrow-left mr-2"></i> Volver
            </button>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
              <button id="generatePdfBtn"
                class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center justify-center w-full sm:w-auto"
                disabled>
                <i class="fas fa-file-pdf mr-2"></i> Generar PDF
              </button>
              <button id="sendWhatsappBtn"
                class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 disabled:opacity-50 flex items-center justify-center w-full sm:w-auto"
                disabled>
                <i class="fab fa-whatsapp mr-2"></i> Enviar WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Burbuja Carrito -->
  <div id="floatingCartBubble" class="floating-cart-bubble hidden">
    <i class="fas fa-shopping-cart text-2xl"></i>
    <span id="cartCountBubble" class="cart-count">0</span>
  </div>

  <!-- Panel Carrito -->
  <div id="cartPanelOverlay" class="cart-panel-overlay hidden">
    <div id="cartPanel" class="cart-panel">
      <div class="cart-panel-header">
        <h2 class="text-xl font-semibold">Tu Cotización</h2>
        <button id="closeCartPanel"><i class="fas fa-times text-lg"></i></button>
      </div>
      <div id="cartItemsPanel" class="cart-panel-body custom-scrollbar">
        <p class="text-center py-10 text-gray-500">Agrega productos para comenzar</p>
      </div>
      <div class="cart-panel-footer">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Descuento (%)</label>
          <input id="globalDiscountPanel" type="number" value="0" min="0" max="100" class="w-full p-2 border rounded-md"/>
        </div>
        <div class="border-t border-gray-200 pt-4">
          <div class="flex justify-between mb-2"><span>Subtotal:</span><span id="subtotalPanel">$0.00</span></div>
          <div class="flex justify-between mb-2"><span>Descuento:</span><span id="discountAmountPanel">-$0.00</span></div>
          <div class="flex justify-between mb-2"><span>Sub c/Desc:</span><span id="subtotalAfterDiscountPanel">$0.00</span></div>
          <div class="flex justify-between mb-2"><span>IVA 16%:</span><span id="taxPanel">$0.00</span></div>
          <div class="flex justify-between font-semibold text-lg"><span>Total:</span><span id="totalPanel">$0.00</span></div>
        </div>
        <div class="mt-6 space-y-3">
          <!-- Aquí quitamos disabled en el HTML -->
          <button id="nextToFormBtn"
            class="w-full bg-tpsDarkBlue text-tpsWhite py-2 rounded-md flex items-center justify-center disabled:opacity-50">
            Siguiente <i class="fas fa-arrow-right ml-2"></i>
          </button>
          <button id="clearCartPanelBtn"
            class="w-full bg-gray-200 text-gray-800 py-2 rounded-md flex items-center justify-center">
            <i class="fas fa-trash-alt mr-2"></i> Limpiar Cotización
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Producto Personalizado -->
  <div id="customProductModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Agregar Producto</h3>
        <button id="closeCustomProductModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="mb-4"><label class="block text-sm mb-1">Descripción:</label>
        <input id="customProductDescription" class="w-full p-2 border rounded-md"/>
      </div>
      <div class="mb-6"><label class="block text-sm mb-1">Precio (sin IVA):</label>
        <input id="customProductPrice" type="number" step="0.01" class="w-full p-2 border rounded-md"/>
      </div>
      <button id="addCustomProductToCartBtn"
        class="w-full bg-tpsOrange text-tpsWhite py-2 rounded-md flex items-center justify-center hover:bg-orange-600">
        <i class="fas fa-plus-circle mr-2"></i> Agregar
      </button>
    </div>
  </div>

  <!-- Modal Calculadora -->
  <div id="calculatorModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Calculadora de Mezclas</h3>
        <button id="closeCalculatorModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div><label class="block text-sm mb-1">Área (m²)</label>
          <input id="mezclaArea" type="number" step="0.01" class="w-full p-2 border rounded-md"/></div>
        <div><label class="block text-sm mb-1">Rendimiento (m²/L)</label>
          <input id="mezclaRendimiento" type="number" step="0.01" class="w-full p-2 border rounded-md"/></div>
      </div>
      <div class="mb-6">
        <label class="block text-sm mb-1">Relación Pint:Catal:Red</label>
        <div class="flex items-center space-x-2">
          <input id="mezclaParteA" type="number" value="4" class="w-1/3 p-2 border rounded-md text-center"/>
          <span>:</span>
          <input id="mezclaParteB" type="number" value="1" class="w-1/3 p-2 border rounded-md text-center"/>
          <span>:</span>
          <input id="mezclaParteC" type="number" value="0" class="w-1/3 p-2 border rounded-md text-center"/>
        </div>
      </div>
      <div class="flex justify-center mb-6">
        <button id="calcularMezclaBtn"
          class="bg-tpsDarkBlue text-tpsWhite py-2 px-4 rounded-md flex items-center hover:bg-gray-800">
          <i class="fas fa-calculator mr-2"></i> Calcular
        </button>
      </div>
      <div id="mezclaResultado" class="hidden p-4 bg-gray-100 rounded-md">
        <h3 class="font-semibold mb-3">Resultados:</h3>
        <p id="mezclaTotalNecesaria" class="mb-2"></p>
        <p id="mezclaResultadoParteA" class="mb-2"></p>
        <p id="mezclaResultadoParteB" class="mb-2"></p>
        <p id="mezclaResultadoParteC"></p>
      </div>
      <div id="mezclaError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
        <p class="font-bold">Error:</p>
        <p id="mezclaErrorMessage"></p>
      </div>
    </div>
  </div>

  <script>
    // Datos de la empresa
    const companyInfo = {
      name: "TPS Recubrimientos",
      address: "Calle Ficticia #123",
      phone: "55 1234 5678",
      email: "contacto@tpsrecubrimientos.com",
      logoUrl: "logotps.png"
    };

    // Variables globales
    let products = [], cart = [], filteredProducts = [], customProductCounter = 0;
    const itemsPerPage = 9; let currentPage = 1;

    // DOM Elements
    const step1 = document.getElementById('step1'),
          step2 = document.getElementById('step2'),
          floatingCartBubble = document.getElementById('floatingCartBubble'),
          cartPanelOverlay    = document.getElementById('cartPanelOverlay'),
          cartPanel           = document.getElementById('cartPanel'),
          nextToFormBtn       = document.getElementById('nextToFormBtn');

    // Al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      setupEventListeners();
      loadCart();
      updateCart();            // habilita/deshabilita botón
      updateCartBubbleCount();
    });

    // Carga productos desde JSON
    function loadProducts() {
      fetch('productos.json')
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          if (!Array.isArray(data)) throw "Formato inválido";
          products = data; filteredProducts = [...data];
          applyFilters();
        })
        .catch(e => {
          console.error(e);
          document.getElementById('productsContainer').innerHTML =
            `<p class="text-red-600 text-center">Error cargando productos</p>`;
          document.getElementById('pagination').classList.add('hidden');
        });
    }

    // Guarda y carga carrito
    function saveCart() {
      localStorage.setItem('tpsCart', JSON.stringify(cart));
      updateCartBubbleCount();
    }
    function loadCart() {
      const s = localStorage.getItem('tpsCart');
      if (s) {
        try { cart = JSON.parse(s) || []; }
        catch { cart = []; }
      }
    }

    // Contador burbuja
    function updateCartBubbleCount() {
      const total = cart.reduce((s,i)=>s + (i.quantity||0), 0);
      document.getElementById('cartCountBubble').textContent = total;
      total ? floatingCartBubble.classList.remove('hidden') : floatingCartBubble.classList.add('hidden');
    }

    // Listeners
    function setupEventListeners() {
      ['filterKeyword1','filterKeyword2','filterKeyword3'].forEach(id=>
        document.getElementById(id).addEventListener('input',()=>{currentPage=1;applyFilters()})
      );
      document.getElementById('applyFilters').addEventListener('click',()=>{currentPage=1;applyFilters()});
      document.getElementById('sortBy').addEventListener('change',()=>{currentPage=1;applyFilters()});

      document.getElementById('prevPageBtn').addEventListener('click',()=>{
        if(currentPage>1){currentPage--;renderProducts(filteredProducts);}
      });
      document.getElementById('nextPageBtn').addEventListener('click',()=>{
        const totalPages = Math.ceil(filteredProducts.length/itemsPerPage);
        if(currentPage<totalPages){currentPage++;renderProducts(filteredProducts);}
      });

      document.getElementById('globalDiscountPanel').addEventListener('input',updateCart);

      document.getElementById('openCustomProductModalBtn').addEventListener('click',()=>customProductModalOverlay.classList.add('visible'));
      document.getElementById('closeCustomProductModalBtn').addEventListener('click',()=>customProductModalOverlay.classList.remove('visible'));
      document.getElementById('addCustomProductToCartBtn').addEventListener('click',addCustomProductToCart);

      document.getElementById('openCalculatorModalBtn').addEventListener('click',openCalculatorModal);
      document.getElementById('closeCalculatorModalBtn').addEventListener('click',closeCalculatorModal);
      calcularMezclaBtn.addEventListener('click',calcularMezcla);

      floatingCartBubble.addEventListener('click',openCartPanel);
      document.getElementById('closeCartPanel').addEventListener('click',closeCartPanel);

      nextToFormBtn.addEventListener('click',goToFormStep);
      document.getElementById('backToCart').addEventListener('click',backToCotizadorStep);
      document.getElementById('generatePdfBtn').addEventListener('click',generatePdf);
      document.getElementById('sendWhatsappBtn').addEventListener('click',sendWhatsappQuote);
      document.getElementById('clearCartPanelBtn').addEventListener('click',clearCart);
    }

    // Mostrar panel carrito
    function openCartPanel() {
      updateCart();  // <-- garantiza habilitación correcta
      cartPanelOverlay.classList.remove('hidden');
      cartPanelOverlay.classList.add('visible');
      setTimeout(()=>cartPanel.classList.add('open'),10);
    }
    function closeCartPanel() {
      cartPanel.classList.remove('open');
      cartPanel.addEventListener('transitionend',()=>{
        cartPanelOverlay.classList.remove('visible');
        cartPanelOverlay.classList.add('hidden');
      },{once:true});
    }

    // Saltar a formulario
    function goToFormStep() {
      if(!cart.length){
        showNotification('Agrega productos al carrito antes de continuar.','bg-yellow-500');
        return;
      }
      closeCartPanel();
      step1.classList.remove('active');
      step2.classList.add('active');
      document.getElementById('generatePdfBtn').disabled = false;
      document.getElementById('sendWhatsappBtn').disabled = false;
    }
    function backToCotizadorStep(){
      step2.classList.remove('active');
      step1.classList.add('active');
    }

    // Filtros y render
    function applyFilters(){
      const k1=document.getElementById('filterKeyword1').value.toLowerCase(),
            k2=document.getElementById('filterKeyword2').value.toLowerCase(),
            k3=document.getElementById('filterKeyword3').value.toLowerCase(),
            min=parseFloat(document.getElementById('minPrice').value)||0,
            max=parseFloat(document.getElementById('maxPrice').value)||Infinity,
            sortBy=document.getElementById('sortBy').value;
      filteredProducts = products.filter(p=>{
        const d=(p.Descripcion||'').toLowerCase();
        const price=parseFloat((p.PrecioPublico||'0').replace(',','.'))||0;
        return (!k1||d.includes(k1))&&(!k2||d.includes(k2))&&(!k3||d.includes(k3))
          && price>=min && price<=max;
      });
      sortProducts(filteredProducts,sortBy);
      renderProducts(filteredProducts);
    }
    function sortProducts(arr,sortBy){
      const [f,o]=sortBy.split('-');
      arr.sort((a,b)=>{
        if(f==='name'){
          const cmp=(a.Descripcion||'').localeCompare(b.Descripcion||'');
          return o==='asc'?cmp:-cmp;
        }
        const pa=parseFloat((a.PrecioPublico||'0').replace(',','.'))||0;
        const pb=parseFloat((b.PrecioPublico||'0').replace(',','.'))||0;
        return o==='asc'?pa-pb:pb-pa;
      });
    }
    function renderProducts(arr){
      const cont=document.getElementById('productsContainer'),
            noMsg=document.getElementById('noProductsMessage'),
            pageInfo=document.getElementById('pageInfo'),
            prevBtn=document.getElementById('prevPageBtn'),
            nextBtn=document.getElementById('nextPageBtn');
      cont.innerHTML='';
      const totalPages=Math.ceil(arr.length/itemsPerPage);
      pageInfo.textContent=`Página ${totalPages?currentPage:0} de ${totalPages}`;
      prevBtn.disabled = currentPage===1 || totalPages===0;
      nextBtn.disabled = currentPage===totalPages || totalPages===0;
      const start=(currentPage-1)*itemsPerPage,
            pageItems=arr.slice(start,start+itemsPerPage);
      if(!pageItems.length){
        noMsg.classList.remove('hidden');
        document.getElementById('pagination').classList.add('hidden');
        return;
      }
      noMsg.classList.add('hidden');
      document.getElementById('pagination').classList.remove('hidden');
      pageItems.forEach(prod=>{
        const inCart=cart.some(i=>i.Clave===prod.Clave),
              qty=inCart?cart.find(i=>i.Clave===prod.Clave).quantity:1,
              price=parseFloat((prod.PrecioPublico||'0').replace(',','.'))||0;
        const card=document.createElement('div');
        card.className='product-card bg-white border rounded-lg overflow-hidden flex flex-col transition';
        card.innerHTML=`
          <div class="p-4 flex-grow">
            <div class="h-32 bg-gray-100 mb-4 flex items-center justify-center overflow-hidden rounded-md">
              <img src="${companyInfo.logoUrl}" class="object-contain h-full w-full"/>
            </div>
            <h3 class="font-semibold text-gray-800 mb-1">${prod.Descripcion||'Sin nombre'}</h3>
            <p class="text-gray-600 text-sm line-clamp-3">${prod.Descripcion||''}</p>
          </div>
          <div class="p-4 border-t flex flex-col">
            <div class="flex justify-between items-center mb-3">
              <span class="font-bold text-tpsDarkBlue text-lg">$${price.toFixed(2)}</span>
            </div>
            <div class="flex items-center">
              <label class="mr-2 text-sm">Cant:</label>
              <input type="number" value="${qty}" min="1" class="quantity-input w-16 p-1 border rounded-md text-center text-sm"/>
              <button class="add-to-cart ${inCart?'bg-gray-400':'bg-tpsOrange hover:bg-orange-600'} text-tpsWhite py-1 px-3 rounded-md text-sm ml-auto transition"
                data-id="${prod.Clave}" ${inCart?'disabled':''}>
                ${inCart?'<i class="fas fa-check mr-1"></i>Agregado':'<i class="fas fa-cart-plus mr-1"></i>Agregar'}
              </button>
            </div>
          </div>`;
        cont.append(card);
      });
      // listeners
      cont.querySelectorAll('.add-to-cart').forEach(btn=>{
        btn.addEventListener('click',e=>{
          const id=e.currentTarget.dataset.id,
                q=parseInt(e.currentTarget.closest('.flex.items-center').querySelector('.quantity-input').value)||1;
          addToCart(id,q);
          btn.disabled=true;
          btn.classList.replace('bg-tpsOrange','bg-gray-400');
          btn.innerHTML='<i class="fas fa-check mr-1"></i>Agregado';
        });
      });
      cont.querySelectorAll('.quantity-input').forEach(inp=>{
        inp.addEventListener('change',e=>{
          const id=e.currentTarget.closest('.product-card').querySelector('.add-to-cart').dataset.id,
                nq=parseInt(e.currentTarget.value)||1;
          if(cart.some(i=>i.Clave==id)) updateCartItemQuantity(id,nq);
        });
      });
    }

    // Carrito
    function addToCart(id,qty=1){
      const prod=products.find(p=>p.Clave==id),
            custom=cart.find(i=>i.Clave==id && i.isCustom);
      if(prod){
        const idx=cart.findIndex(i=>i.Clave==id);
        if(idx>-1) cart[idx].quantity+=qty;
        else cart.push({...prod,quantity:qty});
      } else if(custom){
        custom.quantity+=qty;
      } else {
        showNotification('Error al agregar','bg-red-600'); return;
      }
      saveCart();
      updateCart();
      showNotification('Agregado al carrito','bg-green-600');
    }

    function updateCartItemQuantity(id,qty){
      const idx=cart.findIndex(i=>i.Clave==id);
      if(idx>-1){
        if(qty>0) cart[idx].quantity=qty;
        else cart.splice(idx,1);
        saveCart();
        updateCart();
        renderProducts(filteredProducts);
      }
    }

    function clearCart(){
      if(!cart.length) return;
      if(confirm('¿Limpiar cotización?')){
        cart=[];
        saveCart();
        updateCart();
        renderProducts(filteredProducts);
        showNotification('Cotización limpiada','bg-green-600');
      }
    }

    function updateCart(){
      const panel=document.getElementById('cartItemsPanel');
      panel.innerHTML='';
      if(!cart.length){
        panel.innerHTML='<p class="text-gray-500 text-center py-10">Agrega productos</p>';
        ['subtotalPanel','discountAmountPanel','subtotalAfterDiscountPanel','taxPanel','totalPanel']
          .forEach(id=>document.getElementById(id).textContent='$0.00');
        nextToFormBtn.disabled=true;
        updateCartBubbleCount();
        return;
      }
      let subtotal=0;
      cart.forEach(item=>{
        const price=parseFloat((item.PrecioPublico||'0').replace(',','.'))||0,
              total=price*item.quantity;
        subtotal+=total;
        const div=document.createElement('div');
        div.className='cart-item fade-in p-3 border-b flex justify-between items-center';
        div.innerHTML=`
          <div class="flex items-center flex-grow mr-3">
            <img src="${companyInfo.logoUrl}" class="w-10 h-10 object-contain mr-3 rounded-md"/>
            <div class="flex-grow">
              <h4 class="text-sm font-medium text-gray-800">${item.Descripcion}</h4>
              <p class="text-xs text-gray-500">$${price.toFixed(2)}</p>
            </div>
          </div>
          <div class="flex items-center">
            <input type="number" value="${item.quantity}" min="0" class="cart-quantity-input w-16 p-1 border rounded-md text-center mr-2 text-sm" data-id="${item.Clave}"/>
            <span class="font-semibold mr-3">$${total.toFixed(2)}</span>
            <button class="remove-item text-red-500 hover:text-red-700" data-id="${item.Clave}"><i class="fas fa-times"></i></button>
          </div>`;
        panel.append(div);
      });

      const discount=parseFloat(document.getElementById('globalDiscountPanel').value)||0,
            discountAmount=subtotal*(discount/100),
            after=subtotal-discountAmount,
            tax=after*0.16,
            grand=after+tax;

      document.getElementById('subtotalPanel').textContent=`$${subtotal.toFixed(2)}`;
      document.getElementById('discountAmountPanel').textContent=`-$${discountAmount.toFixed(2)}`;
      document.getElementById('subtotalAfterDiscountPanel').textContent=`$${after.toFixed(2)}`;
      document.getElementById('taxPanel').textContent=`$${tax.toFixed(2)}`;
      document.getElementById('totalPanel').textContent=`$${grand.toFixed(2)}`;

      // habilita siguiente
      const totalItems=cart.reduce((s,i)=>s+i.quantity,0);
      nextToFormBtn.disabled = totalItems===0;

      // listeners dentro del panel
      panel.querySelectorAll('.remove-item').forEach(btn=>{
        btn.addEventListener('click',e=>{
          cart = cart.filter(i=>i.Clave!=e.currentTarget.dataset.id);
          saveCart(); updateCart(); renderProducts(filteredProducts);
        });
      });
      panel.querySelectorAll('.cart-quantity-input').forEach(inp=>{
        inp.addEventListener('change',e=>{
          const id=e.currentTarget.dataset.id,
                nq=parseInt(e.currentTarget.value)||0;
          updateCartItemQuantity(id,nq);
        });
      });

      updateCartBubbleCount();
    }

    // ---- resto de funciones: calculadora, PDF, WhatsApp ----

    function showNotification(msg, bg='bg-green-600'){
      const n=document.createElement('div');
      n.className=`fixed bottom-4 right-4 ${bg} text-white px-4 py-2 rounded-md shadow-lg flex items-center animate-fade-in`;
      n.innerHTML=`<i class="fas fa-info-circle mr-2"></i><span>${msg}</span>`;
      document.body.append(n);
      setTimeout(()=>{
        n.classList.add('opacity-0','transition-opacity','duration-300');
        setTimeout(()=>n.remove(),300);
      },5000);
    }

    // Implementar aquí generatePdf, addPdfContent, sendWhatsappQuote, openCalculatorModal, closeCalculatorModal, calcularMezcla y demás...
  </script>
</body>
</html>
