<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador TPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tpsDarkBlue: '#023047',
            tpsOrange:   '#fb8500',
            tpsWhite:    '#ffffff',
          }
        }
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* Estilos esenciales */
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }
    .custom-scrollbar::-webkit-scrollbar { width:6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background:#888; border-radius:3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background:#555; }
    .floating-cart-bubble {
      position:fixed; bottom:20px; left:20px;
      background:#023047; color:#fff; border-radius:50%;
      width:60px; height:60px; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition:transform .3s; z-index:1000;
    }
    .floating-cart-bubble:hover { transform:scale(1.1); }
    .floating-cart-bubble .cart-count {
      position:absolute; top:-5px; right:-5px;
      background:#fb8500; color:#fff; font-size:.75rem;
      font-weight:bold; padding:2px 6px; border-radius:9999px;
    }
    .cart-panel-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); display:flex; justify-content:end;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s;
    }
    .cart-panel-overlay.visible { visibility:visible; opacity:1; }
    .cart-panel {
      background:#fff; width:90%; max-width:400px; height:100%;
      box-shadow:-4px 0 12px rgba(0,0,0,0.2);
      display:flex; flex-direction:column; transform:translateX(100%);
      transition:transform .3s;
    }
    .cart-panel.open { transform:translateX(0); }
    .cart-panel-header, .cart-panel-footer { padding:1rem; border-color:#e5e7eb; }
    .cart-panel-header { border-bottom:1px solid; display:flex; justify-content:space-between; align-items:center; }
    .cart-panel-body { flex-grow:1; overflow-y:auto; padding:1rem; }
    .step { display:none; }
    .step.active { display:block; }
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      visibility:hidden; opacity:0; transition:visibility .3s,opacity .3s; z-index:1100;
    }
    .modal-overlay.visible { visibility:visible; opacity:1; }
    .modal {
      background:#fff; padding:1.5rem; border-radius:.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      width:90%; max-width:400px; transform:translateY(-20px);
      transition:transform .3s;
    }
    .modal-overlay.visible .modal { transform:translateY(0); }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-10 flex flex-col sm:flex-row items-center justify-center">
      <img src="logotps.png" alt="Logo TPS" class="h-16 mb-4 sm:mb-0 sm:mr-4"/>
      <div>
        <h1 class="text-4xl font-bold text-center text-tpsDarkBlue mb-2">Cotizador TPS</h1>
        <p class="text-center text-gray-600">Genera cotizaciones rápidas</p>
      </div>
      <button id="openCalculatorModalBtn" class="ml-0 sm:ml-6 mt-4 sm:mt-0 bg-tpsOrange text-tpsWhite py-2 px-4 rounded-md hover:bg-orange-600 flex items-center text-sm">
        <i class="fas fa-calculator mr-2"></i> Calculadora
      </button>
    </header>

    <div id="appContainer" class="relative">
      <!-- Paso 1 -->
      <div id="step1" class="step active">
        <!-- Filtros -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
          <h2 class="text-xl font-semibold mb-4">Filtros</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <input id="filterKeyword1" placeholder="Clave 1" class="border p-2 rounded"/>
            <input id="filterKeyword2" placeholder="Clave 2" class="border p-2 rounded"/>
            <input id="filterKeyword3" placeholder="Clave 3" class="border p-2 rounded"/>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="flex space-x-2"><input id="minPrice" type="number" placeholder="Mín" class="border p-2 rounded"/><input id="maxPrice" type="number" placeholder="Máx" class="border p-2 rounded"/></div>
            <select id="sortBy" class="border p-2 rounded">
              <option value="name-asc">Nombre A-Z</option>
              <option value="name-desc">Nombre Z-A</option>
              <option value="price-asc">Precio ↑</option>
              <option value="price-desc">Precio ↓</option>
            </select>
            <button id="applyFilters" class="bg-tpsDarkBlue text-white py-2 rounded flex items-center justify-center">
              <i class="fas fa-filter mr-2"></i> Aplicar
            </button>
          </div>
        </div>
        <!-- Productos -->
        <div class="bg-white p-6 rounded-xl shadow-md">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Productos</h2>
            <button id="openCustomProductModalBtn" class="bg-tpsOrange text-white py-2 px-4 rounded flex items-center text-sm">
              <i class="fas fa-plus mr-2"></i> Personalizado
            </button>
          </div>
          <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <p class="text-gray-500 text-center">Cargando...</p>
          </div>
          <div id="noProductsMessage" class="hidden text-center py-10 text-gray-500"><i class="fas fa-box-open text-4xl mb-3"></i>No hay productos</div>
          <div id="pagination" class="flex justify-center items-center mt-6 space-x-4">
            <button id="prevPageBtn" class="bg-gray-300 py-2 px-4 rounded disabled:opacity-50"><i class="fas fa-arrow-left mr-2"></i>Anterior</button>
            <span id="pageInfo">Página 1 de 1</span>
            <button id="nextPageBtn" class="bg-gray-300 py-2 px-4 rounded disabled:opacity-50">Siguiente<i class="fas fa-arrow-right ml-2"></i></button>
          </div>
        </div>
      </div>

      <!-- Paso 2 -->
      <div id="step2" class="step">
        <div class="bg-white p-6 rounded-xl shadow-md">
          <h2 class="text-xl font-semibold mb-6">Datos</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="prospectName" placeholder="Nombre prospecto" class="border p-2 rounded"/>
            <input id="prospectCompany" placeholder="Empresa prospecto" class="border p-2 rounded"/>
            <input id="projectName" placeholder="Proyecto" class="border p-2 rounded"/>
            <input id="prospectPhone" placeholder="Teléfono (WhatsApp)" class="border p-2 rounded"/>
            <input id="salespersonName" placeholder="Nombre vendedor" class="border p-2 rounded"/>
            <input id="salespersonPhone" placeholder="Teléfono vendedor" class="border p-2 rounded"/>
            <input id="salespersonEmail" placeholder="Correo vendedor" class="border p-2 rounded"/>
          </div>
          <div class="mt-6 flex flex-col sm:flex-row justify-between items-center">
            <button id="backToCart" class="bg-gray-300 text-gray-800 py-2 px-4 rounded flex items-center mb-4 sm:mb-0">
              <i class="fas fa-arrow-left mr-2"></i> Volver
            </button>
            <div class="flex space-x-3 w-full sm:w-auto">
              <button id="generatePdfBtn" disabled class="bg-green-600 text-white py-2 px-4 rounded disabled:opacity-50 flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> PDF
              </button>
              <button id="sendWhatsappBtn" disabled class="bg-green-500 text-white py-2 px-4 rounded disabled:opacity-50 flex items-center">
                <i class="fab fa-whatsapp mr-2"></i> WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Carrito flotante -->
  <div id="floatingCartBubble" class="floating-cart-bubble hidden">
    <i class="fas fa-shopping-cart text-2xl"></i>
    <span id="cartCountBubble" class="cart-count">0</span>
  </div>

  <!-- Panel de carrito -->
  <div id="cartPanelOverlay" class="cart-panel-overlay hidden">
    <div id="cartPanel" class="cart-panel">
      <div class="cart-panel-header">
        <h2 class="font-semibold">Tu Cotización</h2>
        <button id="closeCartPanel"><i class="fas fa-times"></i></button>
      </div>
      <div id="cartItemsPanel" class="cart-panel-body custom-scrollbar">
        <p class="text-gray-500 text-center py-10">Agrega productos</p>
      </div>
      <div class="cart-panel-footer">
        <input id="globalDiscountPanel" type="number" min="0" max="100" value="0" class="w-full p-2 border rounded mb-4" placeholder="Descuento %"/>
        <div class="space-y-2 mb-4">
          <div class="flex justify-between"><span>Subtotal:</span><span id="subtotalPanel">$0.00</span></div>
          <div class="flex justify-between"><span>Descuento:</span><span id="discountAmountPanel">-$0.00</span></div>
          <div class="flex justify-between"><span>Sub c/Desc:</span><span id="subtotalAfterDiscountPanel">$0.00</span></div>
          <div class="flex justify-between"><span>IVA 16%:</span><span id="taxPanel">$0.00</span></div>
          <div class="flex justify-between font-semibold"><span>Total:</span><span id="totalPanel">$0.00</span></div>
        </div>
        <button id="nextToFormBtn" class="w-full bg-tpsDarkBlue text-white py-2 rounded mb-3 disabled:opacity-50 flex items-center justify-center">
          Siguiente <i class="fas fa-arrow-right ml-2"></i>
        </button>
        <button id="clearCartPanelBtn" class="w-full bg-gray-200 text-gray-800 py-2 rounded flex items-center justify-center">
          <i class="fas fa-trash-alt mr-2"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal producto personalizado -->
  <div id="customProductModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">Producto Personalizado</h3>
        <button id="closeCustomProductModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <input id="customProductDescription" placeholder="Descripción" class="w-full p-2 border rounded mb-4"/>
      <input id="customProductPrice" type="number" step="0.01" placeholder="Precio sin IVA" class="w-full p-2 border rounded mb-6"/>
      <button id="addCustomProductToCartBtn" class="w-full bg-tpsOrange text-white py-2 rounded flex items-center justify-center">
        <i class="fas fa-plus-circle mr-2"></i> Agregar
      </button>
    </div>
  </div>

  <!-- Modal calculadora -->
  <div id="calculatorModalOverlay" class="modal-overlay">
    <div class="modal">
      <div class="flex justify-between items-center mb-6">
        <h3 class="font-semibold">Calculadora Mezclas</h3>
        <button id="closeCalculatorModalBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <input id="mezclaArea" type="number" step="0.01" placeholder="Área m²" class="border p-2 rounded"/>
        <input id="mezclaRendimiento" type="number" step="0.01" placeholder="Rend m²/L" class="border p-2 rounded"/>
      </div>
      <div class="mb-6">
        <label class="block mb-1">Relación A:B:C</label>
        <div class="flex items-center space-x-2">
          <input id="mezclaParteA" type="number" value="4" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteB" type="number" value="1" min="0" class="w-1/3 p-2 border rounded text-center"/>
          <span>:</span>
          <input id="mezclaParteC" type="number" value="0" min="0" class="w-1/3 p-2 border rounded text-center"/>
        </div>
      </div>
      <button id="calcularMezclaBtn" class="w-full bg-tpsDarkBlue text-white py-2 rounded flex items-center justify-center mb-6">
        <i class="fas fa-calculator mr-2"></i> Calcular
      </button>
      <div id="mezclaResultado" class="hidden p-4 bg-gray-100 rounded mb-4">
        <p id="mezclaTotalNecesaria" class="mb-2"></p>
        <p id="mezclaResultadoParteA" class="mb-2"></p>
        <p id="mezclaResultadoParteB" class="mb-2"></p>
        <p id="mezclaResultadoParteC"></p>
      </div>
      <div id="mezclaError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <p id="mezclaErrorMessage"></p>
      </div>
    </div>
  </div>

  <script>
    const companyInfo = {
      name:    "TPS Recubrimientos",
      address: "Calle Ficticia #123",
      phone:   "55 1234 5678",
      email:   "contacto@tpsrecubrimientos.com",
      logoUrl: "logotps.png"
    };

    let products = [], cart = [], filteredProducts = [], customProductCounter = 0;
    const itemsPerPage = 9; let currentPage = 1;

    // Elementos
    const step1  = document.getElementById('step1'),
          step2  = document.getElementById('step2'),
          bubble = document.getElementById('floatingCartBubble'),
          panelO = document.getElementById('cartPanelOverlay'),
          panel  = document.getElementById('cartPanel'),
          nextBtn= document.getElementById('nextToFormBtn'),
          customOverlay  = document.getElementById('customProductModalOverlay'),
          calcOverlay    = document.getElementById('calculatorModalOverlay');

    document.addEventListener('DOMContentLoaded',()=>{
      loadProducts();
      setupEventListeners();
      loadCart();
      updateCart();
      updateCartBubbleCount();
    });

    function loadProducts(){
      fetch('productos.json')
        .then(r=>r.ok?r.json():Promise.reject(r.status))
        .then(data=>{
          if(!Array.isArray(data)) throw "Formato inválido";
          products=data; filteredProducts=[...data];
          applyFilters();
        })
        .catch(e=>{
          console.error(e);
          document.getElementById('productsContainer').innerHTML='<p class="text-red-600 text-center">Error cargando productos</p>';
          document.getElementById('pagination').classList.add('hidden');
        });
    }

    function saveCart(){
      localStorage.setItem('tpsCart',JSON.stringify(cart));
      updateCartBubbleCount();
    }
    function loadCart(){
      const s=localStorage.getItem('tpsCart');
      if(s) try{cart=JSON.parse(s)||[]}catch{cart=[];}
    }
    function updateCartBubbleCount(){
      const total=cart.reduce((s,i)=>s+i.quantity,0);
      document.getElementById('cartCountBubble').textContent=total;
      total?bubble.classList.remove('hidden'):bubble.classList.add('hidden');
    }

    function setupEventListeners(){
      ['filterKeyword1','filterKeyword2','filterKeyword3']
        .forEach(id=>document.getElementById(id).addEventListener('input',()=>{
          currentPage=1;applyFilters();
        }));
      document.getElementById('applyFilters').addEventListener('click',()=>{currentPage=1;applyFilters()});
      document.getElementById('sortBy').addEventListener('change',()=>{currentPage=1;applyFilters()});

      document.getElementById('prevPageBtn').addEventListener('click',()=>{
        if(currentPage>1){currentPage--;renderProducts(filteredProducts);}
      });
      document.getElementById('nextPageBtn').addEventListener('click',()=>{
        const tp=Math.ceil(filteredProducts.length/itemsPerPage);
        if(currentPage<tp){currentPage++;renderProducts(filteredProducts);}
      });

      document.getElementById('globalDiscountPanel').addEventListener('input',updateCart);

      document.getElementById('openCustomProductModalBtn').addEventListener('click',()=>customOverlay.classList.add('visible'));
      document.getElementById('closeCustomProductModalBtn').addEventListener('click',()=>customOverlay.classList.remove('visible'));
      document.getElementById('addCustomProductToCartBtn').addEventListener('click',addCustomProductToCart);

      document.getElementById('openCalculatorModalBtn').addEventListener('click',()=>{
        calcOverlay.classList.add('visible');
        document.getElementById('mezclaResultado').classList.add('hidden');
        document.getElementById('mezclaError').classList.add('hidden');
      });
      document.getElementById('closeCalculatorModalBtn').addEventListener('click',()=>calcOverlay.classList.remove('visible'));
      document.getElementById('calcularMezclaBtn').addEventListener('click',calcularMezcla);

      bubble.addEventListener('click',openCartPanel);
      document.getElementById('closeCartPanel').addEventListener('click',closeCartPanel);

      nextBtn.addEventListener('click',goToFormStep);
      document.getElementById('backToCart').addEventListener('click',backToCotizadorStep);
      document.getElementById('generatePdfBtn').addEventListener('click',generatePdf);
      document.getElementById('sendWhatsappBtn').addEventListener('click',sendWhatsappQuote);
      document.getElementById('clearCartPanelBtn').addEventListener('click',clearCart);
    }

    function openCartPanel(){
      updateCart();
      panelO.classList.remove('hidden');
      panelO.classList.add('visible');
      setTimeout(()=>panel.classList.add('open'),10);
    }
    function closeCartPanel(){
      panel.classList.remove('open');
      panel.addEventListener('transitionend',()=>{
        panelO.classList.remove('visible');
        panelO.classList.add('hidden');
      },{once:true});
    }

    function goToFormStep(){
      if(!cart.length){ showNotification('Agrega productos primero.','bg-yellow-500'); return; }
      closeCartPanel();
      step1.classList.remove('active');
      step2.classList.add('active');
      document.getElementById('generatePdfBtn').disabled=false;
      document.getElementById('sendWhatsappBtn').disabled=false;
    }
    function backToCotizadorStep(){
      step2.classList.remove('active');
      step1.classList.add('active');
    }

    function applyFilters(){
      const k1=document.getElementById('filterKeyword1').value.toLowerCase(),
            k2=document.getElementById('filterKeyword2').value.toLowerCase(),
            k3=document.getElementById('filterKeyword3').value.toLowerCase(),
            min= parseFloat(document.getElementById('minPrice').value)||0,
            max= parseFloat(document.getElementById('maxPrice').value)||Infinity,
            sortBy=document.getElementById('sortBy').value;
      filteredProducts=products.filter(p=>{
        const d=(p.Descripcion||'').toLowerCase(),
              price=parseFloat((p.PrecioPublico||'0').replace(',','.'))||0;
        return (!k1||d.includes(k1))&&(!k2||d.includes(k2))&&(!k3||d.includes(k3))
          &&price>=min&&price<=max;
      });
      sortProducts(filteredProducts,sortBy);
      renderProducts(filteredProducts);
    }
    function sortProducts(arr,sortBy){
      const [f,o]=sortBy.split('-');
      arr.sort((a,b)=>{
        if(f==='name'){
          const cmp=(a.Descripcion||'').localeCompare(b.Descripcion||'');
          return o==='asc'?cmp:-cmp;
        }
        const pa=parseFloat((a.PrecioPublico||'0').replace(',','.'))||0,
              pb=parseFloat((b.PrecioPublico||'0').replace(',','.'))||0;
        return o==='asc'?pa-pb:pb-pa;
      });
    }
    function renderProducts(arr){
      const cont=document.getElementById('productsContainer'),
            noMsg=document.getElementById('noProductsMessage'),
            pageInfo=document.getElementById('pageInfo'),
            prevBtn=document.getElementById('prevPageBtn'),
            nextBtn=document.getElementById('nextPageBtn');
      cont.innerHTML='';
      const tp=Math.ceil(arr.length/itemsPerPage);
      pageInfo.textContent=`Página ${tp?currentPage:0} de ${tp}`;
      prevBtn.disabled=currentPage===1||tp===0;
      nextBtn.disabled=currentPage===tp||tp===0;
      const start=(currentPage-1)*itemsPerPage,
            pageItems=arr.slice(start,start+itemsPerPage);
      if(!pageItems.length){
        noMsg.classList.remove('hidden');
        document.getElementById('pagination').classList.add('hidden');
        return;
      }
      noMsg.classList.add('hidden');
      document.getElementById('pagination').classList.remove('hidden');
      pageItems.forEach(prod=>{
        const inCart=cart.some(i=>i.Clave===prod.Clave),
              qty=inCart?cart.find(i=>i.Clave===prod.Clave).quantity:1,
              price=parseFloat((prod.PrecioPublico||'0').replace(',','.'))||0;
        const card=document.createElement('div');
        card.className='product-card bg-white border rounded flex flex-col transition';
        card.innerHTML=`
          <div class="p-4 flex-grow">
            <div class="h-32 bg-gray-100 mb-4 flex items-center justify-center overflow-hidden rounded-md">
              <img src="${companyInfo.logoUrl}" class="object-contain h-full w-full"/>
            </div>
            <h3 class="font-semibold text-gray-800 mb-1">${prod.Descripcion||'—'}</h3>
          </div>
          <div class="p-4 border-t flex items-center">
            <span class="font-bold text-tpsDarkBlue mr-auto">$${price.toFixed(2)}</span>
            <input type="number" value="${qty}" min="1" class="quantity-input w-16 p-1 border rounded text-center mr-2 text-sm"/>
            <button class="add-to-cart ${inCart?'bg-gray-400':'bg-tpsOrange hover:bg-orange-600'} text-white py-1 px-3 rounded text-sm" data-id="${prod.Clave}" ${inCart?'disabled':''}>
              ${inCart?'<i class="fas fa-check"></i>':'<i class="fas fa-cart-plus"></i>'}
            </button>
          </div>`;
        cont.append(card);
      });
      cont.querySelectorAll('.add-to-cart').forEach(btn=>{
        btn.addEventListener('click',e=>{
          const id=btn.dataset.id, q=parseInt(btn.previousElementSibling.value)||1;
          addToCart(id,q);
          btn.disabled=true; btn.classList.replace('bg-tpsOrange','bg-gray-400'); btn.innerHTML='<i class="fas fa-check"></i>';
        });
      });
      cont.querySelectorAll('.quantity-input').forEach(inp=>{
        inp.addEventListener('change',e=>{
          const id=e.currentTarget.nextElementSibling.dataset.id,
                nq=parseInt(e.currentTarget.value)||1;
          if(cart.some(i=>i.Clave==id)) updateCartItemQuantity(id,nq);
        });
      });
    }

    // Carrito
    function addCustomProductToCart(){
      const desc=document.getElementById('customProductDescription').value.trim(),
            price=parseFloat(document.getElementById('customProductPrice').value);
      if(!desc||isNaN(price)||price<0){ showNotification('Descripción o precio inválido','bg-yellow-500'); return; }
      const id=`custom-${Date.now()}-${customProductCounter++}`;
      cart.push({Clave:id,Descripcion:desc,PrecioPublico:price,quantity:1,isCustom:true});
      saveCart(); updateCart(); customOverlay.classList.remove('visible');
      showNotification('Producto personalizado agregado','bg-green-600');
    }

    function addToCart(id,qty=1){
      const prod=products.find(p=>p.Clave==id), custom=cart.find(i=>i.Clave==id&&i.isCustom);
      if(prod){
        const idx=cart.findIndex(i=>i.Clave==id);
        if(idx>-1) cart[idx].quantity+=qty; else cart.push({...prod,quantity:qty});
      } else if(custom) custom.quantity+=qty;
      else { showNotification('Error agregando','bg-red-600'); return; }
      saveCart(); updateCart(); showNotification('Agregado al carrito','bg-green-600');
    }

    function updateCartItemQuantity(id,qty){
      const idx=cart.findIndex(i=>i.Clave==id);
      if(idx>-1){
        if(qty>0) cart[idx].quantity=qty; else cart.splice(idx,1);
        saveCart(); updateCart(); renderProducts(filteredProducts);
      }
    }

    function clearCart(){
      if(!cart.length) return;
      if(confirm('Limpiar cotización?')){
        cart=[]; saveCart(); updateCart(); renderProducts(filteredProducts);
        showNotification('Cotización limpiada','bg-green-600');
      }
    }

    function updateCart(){
      const panel=document.getElementById('cartItemsPanel');
      panel.innerHTML='';
      if(!cart.length){
        panel.innerHTML='<p class="text-gray-500 text-center py-10">Agrega productos</p>';
        ['subtotalPanel','discountAmountPanel','subtotalAfterDiscountPanel','taxPanel','totalPanel']
          .forEach(id=>document.getElementById(id).textContent='$0.00');
        nextBtn.disabled=true; updateCartBubbleCount(); return;
      }
      let subtotal=0;
      cart.forEach(item=>{
        const price=parseFloat((item.PrecioPublico||'0').replace(',','.'))||0,
              tot=price*item.quantity; subtotal+=tot;
        const div=document.createElement('div');
        div.className='cart-item fade-in p-3 border-b flex justify-between items-center';
        div.innerHTML=`
          <div class="flex items-center mr-3">
            <img src="${companyInfo.logoUrl}" class="w-10 h-10 object-contain mr-3 rounded"/>
            <div><h4 class="font-medium">${item.Descripcion}</h4><p class="text-xs text-gray-500">$${price.toFixed(2)}</p></div>
          </div>
          <div class="flex items-center">
            <input type="number" value="${item.quantity}" min="0" class="cart-quantity-input w-16 p-1 border rounded text-center mr-2 text-sm" data-id="${item.Clave}"/>
            <span class="font-semibold mr-3">$${tot.toFixed(2)}</span>
            <button class="remove-item text-red-500"><i class="fas fa-times"></i></button>
          </div>`;
        panel.append(div);
      });
      const discount=parseFloat(document.getElementById('globalDiscountPanel').value)||0,
            discAmt=subtotal*(discount/100),
            subAfter=subtotal-discAmt,
            tax=subAfter*0.16,
            grand=subAfter+tax;
      document.getElementById('subtotalPanel').textContent=`$${subtotal.toFixed(2)}`;
      document.getElementById('discountAmountPanel').textContent=`-$${discAmt.toFixed(2)}`;
      document.getElementById('subtotalAfterDiscountPanel').textContent=`$${subAfter.toFixed(2)}`;
      document.getElementById('taxPanel').textContent=`$${tax.toFixed(2)}`;
      document.getElementById('totalPanel').textContent=`$${grand.toFixed(2)}`;
      const totalItems=cart.reduce((s,i)=>s+i.quantity,0);
      nextBtn.disabled = totalItems===0;
      panel.querySelectorAll('.remove-item').forEach((btn,i)=>{
        btn.addEventListener('click',()=>{cart.splice(i,1); saveCart(); updateCart(); renderProducts(filteredProducts);});
      });
      panel.querySelectorAll('.cart-quantity-input').forEach(inp=>{
        inp.addEventListener('change',e=>{
          const id=e.currentTarget.dataset.id, nq=parseInt(e.currentTarget.value)||0;
          updateCartItemQuantity(id,nq);
        });
      });
      updateCartBubbleCount();
    }

    // Calculadora
    function calcularMezcla(){
      const area=parseFloat(document.getElementById('mezclaArea').value),
            rend=parseFloat(document.getElementById('mezclaRendimiento').value),
            A=parseFloat(document.getElementById('mezclaParteA').value),
            B=parseFloat(document.getElementById('mezclaParteB').value),
            C=parseFloat(document.getElementById('mezclaParteC').value);
      if(!area||!rend){ showMezErro("Área o rendimiento inválido"); return;}
      if(A+B+C===0){ showMezErro("Relación inválida"); return; }
      const total=area/rend, unit=total/(A+B+C);
      document.getElementById('mezclaTotalNecesaria').textContent=`Total: ${total.toFixed(2)} L`;
      document.getElementById('mezclaResultadoParteA').textContent=`A: ${(unit*A).toFixed(2)} L`;
      document.getElementById('mezclaResultadoParteB').textContent=`B: ${(unit*B).toFixed(2)} L`;
      if(C>0){
        document.getElementById('mezclaResultadoParteC').textContent=`C: ${(unit*C).toFixed(2)} L`;
        document.getElementById('mezclaResultadoParteC').classList.remove('hidden');
      } else document.getElementById('mezclaResultadoParteC').classList.add('hidden');
      document.getElementById('mezclaError').classList.add('hidden');
      document.getElementById('mezclaResultado').classList.remove('hidden');
    }
    function showMezErro(msg){
      document.getElementById('mezclaErrorMessage').textContent=msg;
      document.getElementById('mezclaResultado').classList.add('hidden');
      document.getElementById('mezclaError').classList.remove('hidden');
    }

    // PDF y WhatsApp (igual que antes, sin redeclaraciones)
    function generatePdf(){
      const { jsPDF }=window.jspdf, doc=new jsPDF();
      const pName=document.getElementById('prospectName').value||'N/A',
            pComp=document.getElementById('prospectCompany').value||'N/A',
            proj=document.getElementById('projectName').value||'N/A',
            sName=document.getElementById('salespersonName').value||'N/A',
            sPhone=document.getElementById('salespersonPhone').value||'N/A',
            sEmail=document.getElementById('salespersonEmail').value||'N/A',
            discount=parseFloat(document.getElementById('globalDiscountPanel').value)||0;
      doc.setFontSize(20); doc.setTextColor('#023047'); doc.text(companyInfo.name,14,20);
      const img=new Image();
      img.onload=()=>{
        doc.addImage(img,'PNG',150,10,50,25);
        addPdfContent(doc,pName,pComp,proj,sName,sPhone,sEmail,discount);
        doc.save(`Cotizacion_${pName}_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification('PDF generado','bg-green-600');
      };
      img.onerror=()=>{
        addPdfContent(doc,pName,pComp,proj,sName,sPhone,sEmail,discount);
        doc.save(`Cotizacion_${pName}_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification('PDF (sin logo)','bg-yellow-500');
      };
      img.src=companyInfo.logoUrl;
    }
    function addPdfContent(doc,prospectName,prospectCompany,projectName,
      salespersonName,salespersonPhone,salespersonEmail,globalDiscount
    ){
      doc.setFont('helvetica').setFontSize(10).setTextColor(0,0,0);
      doc.text(`Dirección: ${companyInfo.address}`,14,26);
      doc.text(`Teléfono: ${companyInfo.phone}`,14,30);
      doc.text(`Email: ${companyInfo.email}`,14,34);
      doc.setFontSize(12).setTextColor('#023047').text('Datos del Prospecto:',14,45);
      doc.setFontSize(10).setTextColor(0,0,0);
      doc.text(`Nombre: ${prospectName}`,14,51);
      doc.text(`Empresa: ${prospectCompany}`,14,55);
      doc.text(`Proyecto: ${projectName}`,14,59);
      doc.text(`Vendedor: ${salespersonName}`,14,63);
      doc.text(`Tel: ${salespersonPhone}`,14,67);
      doc.text(`Email: ${salespersonEmail}`,14,71);
      doc.setFontSize(16).setTextColor('#023047')
        .text('Detalle de la Cotización',105,85,{align:'center'});
      doc.setFontSize(10).setTextColor(0,0,0)
        .text(`Fecha: ${new Date().toLocaleDateString()}`,14,95);

      const body=cart.map(item=>{
        const price=parseFloat((item.PrecioPublico||'0').replace(',','.'))||0,
              total=price*item.quantity;
        return [
          item.Descripcion||'N/A','N/A','N/A',
          `$${price.toFixed(2)}`,item.quantity,
          `$${total.toFixed(2)}`
        ];
      });
      const subtotal=cart.reduce((s,i)=>{
        const p=parseFloat((i.PrecioPublico||'0').replace(',','.'))||0;
        return s+p*i.quantity;
      },0);
      const discountAmount=subtotal*(globalDiscount/100),
            subAfter=subtotal-discountAmount,
            tax=subAfter*0.16,
            grand=subAfter+tax;
      body.push([{content:'Subtotal:',colSpan:5,styles:{halign:'right',fontStyle:'bold'}},`$${subtotal.toFixed(2)}`]);
      if(globalDiscount>0){
        body.push([{content:`Descuento (${globalDiscount}%):`,colSpan:5,styles:{halign:'right',fontStyle:'bold'}},
                   {content:`-$${discountAmount.toFixed(2)}`,styles:{textColor:[220,38,38],fontStyle:'bold'}}]);
        body.push([{content:'Sub c/Desc:',colSpan:5,styles:{halign:'right',fontStyle:'bold'}},`$${subAfter.toFixed(2)}`]);
      }
      body.push([{content:'IVA 16%:',colSpan:5,styles:{halign:'right',fontStyle:'bold'}},`$${tax.toFixed(2)}`]);
      body.push([{content:'Total:',colSpan:5,styles:{halign:'right',fontStyle:'bold'}},
                 {content:`$${grand.toFixed(2)}`,styles:{textColor:[40,53,147],fontStyle:'bold'}}]);

      doc.autoTable({
        startY:105,
        head:[['Producto','Pres.','Color','Precio','Cant','Total']],
        body,
        headStyles:{fillColor:[2,48,71],textColor:255,fontStyle:'bold'},
        styles:{cellPadding:3,fontSize:9,valign:'middle'},
        columnStyles:{0:{cellWidth:70},3:{halign:'right'},4:{halign:'center'},5:{halign:'right'}},
        didDrawPage:d=>{
          doc.setFontSize(10).setTextColor(100)
            .text('Generado por TPS Recubrimientos',105,doc.internal.pageSize.height-10,{align:'center'});
        }
      });

      let y=doc.lastAutoTable.finalY+15;
      [
        "• Cotización válida 30 días.",
        "• Precios sujetos a cambio sin aviso."
      ].forEach(line=>{
        doc.splitTextToSize(line,doc.internal.pageSize.width-28)
          .forEach(txt=>{
            if(y>doc.internal.pageSize.height-20){doc.addPage();y=20;}
            doc.text(txt,14,y);
            y+=7;
          });
        y+=3;
      });

      const sellerLine=`• Contacto: ${salespersonName} al ${salespersonPhone} / ${salespersonEmail}.`;
      doc.splitTextToSize(sellerLine,doc.internal.pageSize.width-28)
        .forEach(txt=>{
          if(y>doc.internal.pageSize.height-20){doc.addPage();y=20;}
          doc.text(txt,14,y); y+=7;
        });
    }

    function sendWhatsappQuote(){
      const phone=document.getElementById('prospectPhone').value.trim();
      if(!phone){showNotification('Ingresa teléfono','bg-yellow-500');return;}
      let msg=`¡Hola ${document.getElementById('prospectName').value||'Prospecto'}!\n\nCotización:\n`;
      cart.forEach(item=>{
        const p=parseFloat((item.PrecioPublico||'0').replace(',','.'))||0;
        msg+=`- ${item.Descripcion}(x${item.quantity}): $${(p*item.quantity).toFixed(2)}\n`;
      });
      const subtotal=cart.reduce((s,i)=>s+(parseFloat((i.PrecioPublico||'0').replace(',','.'))||0)*i.quantity,0),
            discount=parseFloat(document.getElementById('globalDiscountPanel').value)||0,
            discAmt=subtotal*(discount/100),
            after=subtotal-discAmt,
            tax=after*0.16,
            grand=after+tax;
      msg+=`\nSubtotal: $${subtotal.toFixed(2)}`;
      if(discount>0){
        msg+=`\nDescuento(${discount}%): -$${discAmt.toFixed(2)}`;
        msg+=`\nSub c/Desc: $${after.toFixed(2)}`;
      }
      msg+=`\nIVA16%: $${tax.toFixed(2)}`;
      msg+=`\nTotal: *$${grand.toFixed(2)}*`;
      msg+=`\n\n Contacto: ${document.getElementById('salespersonName').value||''} ${document.getElementById('salespersonPhone').value||''}`;
      const encoded=encodeURIComponent(msg);
      let num=phone.replace(/[\s\-\(\)]/g,'');
      if(!num.startsWith('+')) num='+52'+num;
      window.open(`https://wa.me/${num}?text=${encoded}`,'_blank');
      showNotification('Listo para WhatsApp','bg-blue-500');
    }

    function showNotification(msg,bg='bg-green-600'){
      const n=document.createElement('div');
      n.className=`fixed bottom-4 right-4 ${bg} text-white px-4 py-2 rounded shadow-lg flex items-center animate-fade-in`;
      n.innerHTML=`<i class="fas fa-info-circle mr-2"></i><span>${msg}</span>`;
      document.body.append(n);
      setTimeout(()=>{
        n.classList.add('opacity-0','transition-opacity','duration-300');
        setTimeout(()=>n.remove(),300);
      },5000);
    }
  </script>
</body>
</html>
